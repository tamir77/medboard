<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MedNet â€” Revenue Distribution</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- PASSWORD GATE -->
<style>
#gate {
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(135deg, #0f1e38 0%, #152847 60%, #1a3a60 100%);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Heebo', sans-serif; direction: rtl;
}
#gate::before {
  content: '';
  position: absolute; inset: 0;
  background: repeating-linear-gradient(-50deg, transparent, transparent 60px, rgba(255,255,255,0.012) 60px, rgba(255,255,255,0.012) 61px);
}
.gate-box {
  position: relative; z-index: 1;
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(20px);
  border: 1.5px solid rgba(255,255,255,0.15);
  border-radius: 24px;
  padding: 3rem 3rem 2.5rem;
  width: 100%; max-width: 400px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.4);
  text-align: center;
}
.gate-logo {
  width: 60px; height: 60px; border-radius: 16px;
  background: rgba(255,255,255,0.12);
  border: 1.5px solid rgba(255,255,255,0.2);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.7rem; margin: 0 auto 1.4rem;
}
.gate-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem; color: #fff; font-weight: 700; margin-bottom: 0.3rem;
}
.gate-sub { font-size: 0.78rem; color: rgba(255,255,255,0.45); margin-bottom: 2rem; letter-spacing: 0.5px; }
.gate-label { display: block; font-size: 0.72rem; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: rgba(255,255,255,0.45); text-align: right; margin-bottom: 0.5rem; }
.gate-input {
  width: 100%; padding: 0.85rem 1.1rem;
  border-radius: 12px;
  border: 1.5px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  color: #fff; font-family: 'Heebo', sans-serif; font-size: 1rem;
  outline: none; transition: border-color 0.2s, background 0.2s;
  text-align: right; letter-spacing: 2px;
  margin-bottom: 1.2rem;
}
.gate-input:focus { border-color: rgba(255,255,255,0.45); background: rgba(255,255,255,0.12); }
.gate-input.shake { animation: shake 0.4s ease; border-color: #ef4444; }
.gate-btn {
  width: 100%; padding: 0.9rem;
  border-radius: 12px; border: none;
  background: #fff; color: #152847;
  font-family: 'Heebo', sans-serif; font-size: 0.95rem; font-weight: 800;
  cursor: pointer; transition: all 0.2s;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
}
.gate-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,0,0,0.3); }
.gate-btn:active { transform: translateY(0); }
.gate-err {
  margin-top: 1rem; font-size: 0.78rem; color: #f87171; font-weight: 600;
  min-height: 1.2em; transition: opacity 0.2s;
}
.gate-conf {
  margin-top: 1.5rem; font-size: 0.68rem; color: rgba(255,255,255,0.25);
  letter-spacing: 1px; text-transform: uppercase;
  display: flex; align-items: center; justify-content: center; gap: 0.4rem;
}
@keyframes shake {
  0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)} 40%{transform:translateX(8px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)}
}
@keyframes fadeOut {
  to { opacity: 0; pointer-events: none; }
}
</style>

<script>
// SHA-256 hash of "o12345" â€” password never stored in plain text
const HASH = '0555778e15e14e006a88a8593fb17650d29ced7eb43c08b40c801791e4c42ef7';

async function sha256(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function checkPassword() {
  const input = document.getElementById('pwInput');
  const err   = document.getElementById('pwErr');
  const val   = input.value.trim();
  if (!val) return;

  const hash = await sha256(val);
  if (hash === HASH) {
    document.getElementById('gate').style.animation = 'fadeOut 0.5s ease forwards';
    setTimeout(() => document.getElementById('gate').remove(), 500);
  } else {
    err.textContent = 'âŒ ×¡×™×¡××” ×©×’×•×™×” â€” × ×¡×” ×©×•×‘';
    input.classList.add('shake');
    input.value = '';
    setTimeout(() => input.classList.remove('shake'), 400);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('pwInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') checkPassword();
    document.getElementById('pwErr').textContent = '';
  });
});
</script>
<style>
:root {
  --navy:  #152847;
  --navy2: #1e3a5f;
  --bg:    #f2f5fb;
  --white: #ffffff;
  --border:#e0e8f5;
  --text:  #111827;
  --text2: #374151;
  --text3: #6b7280;
  --text4: #9ca3af;
  --c-dr: #3b6fd4;
  --c-em: #7c3aed;
  --c-co: #0891b2;
  --c-vm: #d97706;
  --c-pr: #059669;
  --c-lo: #dc2626;
  --radius: 16px;
  --shadow: 0 1px 4px rgba(21,40,71,0.07), 0 6px 24px rgba(21,40,71,0.07);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Heebo', sans-serif; background: var(--bg); color: var(--text); direction: rtl; min-height: 100vh; }

/* TOP BAND */
.top-band {
  background: linear-gradient(130deg, #152847 0%, #1e3a5f 60%, #1a4a72 100%);
  padding: 1.5rem 2.5rem 2rem;
  position: relative; overflow: hidden;
}
.top-band::before {
  content: '';
  position: absolute; inset: 0;
  background: repeating-linear-gradient(-50deg, transparent, transparent 50px, rgba(255,255,255,0.012) 50px, rgba(255,255,255,0.012) 51px);
}
.band-inner { position: relative; z-index: 1; max-width: 1300px; margin: 0 auto; }
.band-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2.5rem; }
.brand { display: flex; align-items: center; gap: 0.9rem; }
.brand-mk { width: 44px; height: 44px; border-radius: 12px; background: rgba(255,255,255,0.13); border: 1.5px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
.brand-nm { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: #fff; }
.brand-sb { font-size: 0.62rem; color: rgba(255,255,255,0.45); text-transform: uppercase; letter-spacing: 2px; font-weight: 600; }
.nav-right { display: flex; gap: 0.6rem; align-items: center; }
.nav-pill { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.18); color: rgba(255,255,255,0.75); font-size: 0.74rem; font-weight: 600; padding: 0.38rem 1rem; border-radius: 50px; }
.nav-btn { background: #fff; color: var(--navy); font-family: 'Heebo', sans-serif; font-size: 0.78rem; font-weight: 800; padding: 0.42rem 1.2rem; border-radius: 50px; border: none; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.15); transition: all 0.18s; }
.nav-btn-upload { background: rgba(255,255,255,0.18) !important; color: #fff !important; border: 1.5px solid rgba(255,255,255,0.3) !important; }
.nav-btn-upload:hover { background: rgba(255,255,255,0.28) !important; }
@keyframes popIn { from{opacity:0;transform:scale(0.92)} to{opacity:1;transform:scale(1)} }

/* â”€â”€ MODAL SYSTEM (iOS-safe) â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0; z-index: 8000;
  background: rgba(15,30,56,0.72);
  display: flex; align-items: center; justify-content: center;
  font-family: 'Heebo', sans-serif; direction: rtl;
  -webkit-overflow-scrolling: touch;
}
.modal-hidden { display: none !important; }
.modal-box {
  background: #fff; border-radius: 20px;
  padding: 2.5rem 2.5rem 2rem;
  width: calc(100% - 2rem); box-shadow: 0 24px 80px rgba(0,0,0,0.35);
  animation: popIn 0.25s ease;
  max-height: 90vh; overflow-y: auto;
}

/* â”€â”€ CEO DASHBOARD â”€â”€ */
.ceo-section {
  margin: 0 2rem 0;
  border-top: 2px solid #e0e8f5;
  padding: 2rem 0;
}
.ceo-title { font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:700; color:var(--navy); margin-bottom:0.15rem; }
.ceo-sub { font-size:0.72rem; color:var(--text3); margin-bottom:1.5rem; }
.ceo-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:1.2rem; }
@media(max-width:960px){ .ceo-grid{grid-template-columns:1fr 1fr} }
@media(max-width:600px){ .ceo-grid{grid-template-columns:1fr} }

.ceo-card {
  background: var(--white); border:1.5px solid var(--border);
  border-radius:14px; padding:1.2rem 1.3rem;
  box-shadow:var(--shadow);
}
.ceo-card-title { font-size:0.72rem; font-weight:800; letter-spacing:0.8px; text-transform:uppercase; color:var(--text3); margin-bottom:1rem; display:flex; align-items:center; gap:0.4rem; }
.traffic-row { display:flex; align-items:center; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid var(--border); }
.traffic-row:last-child { border-bottom:none; }
.traffic-name { font-size:0.82rem; font-weight:600; color:var(--text); }
.traffic-light { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.traffic-pct { font-size:0.78rem; font-weight:800; }
.tl-green  { background:#22c55e; box-shadow:0 0 6px #22c55e88; }
.tl-yellow { background:#f59e0b; box-shadow:0 0 6px #f59e0b88; }
.tl-red    { background:#ef4444; box-shadow:0 0 6px #ef444488; }
.tl-gray   { background:#94a3b8; }

.mom-row { display:flex; align-items:center; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid var(--border); }
.mom-row:last-child { border-bottom:none; }
.mom-name { font-size:0.8rem; font-weight:600; color:var(--text); }
.mom-delta { font-size:0.78rem; font-weight:800; display:flex; align-items:center; gap:0.25rem; }
.mom-up   { color:#059669; }
.mom-down { color:#dc2626; }
.mom-flat { color:#94a3b8; }

.alert-item { display:flex; align-items:flex-start; gap:0.6rem; padding:0.55rem 0; border-bottom:1px solid var(--border); }
.alert-item:last-child { border-bottom:none; }
.alert-icon { font-size:1rem; flex-shrink:0; margin-top:0.05rem; }
.alert-text { font-size:0.78rem; color:var(--text2); line-height:1.5; }
.alert-text strong { color:var(--navy); }


.band-title { text-align: center; margin-bottom: 2.5rem; }
.band-eye { font-size: 0.68rem; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: rgba(255,255,255,0.45); margin-bottom: 0.5rem; }
.band-title h1 { font-family: 'Playfair Display', serif; font-size: 2.4rem; color: #fff; font-weight: 700; line-height: 1.15; letter-spacing: -0.3px; }
.band-title p { font-size: 0.88rem; color: rgba(255,255,255,0.6); margin-top: 0.55rem; }

/* FILTER BUTTONS */
.filter-row {
  display: flex; align-items: center; gap: 0.5rem; justify-content: center; flex-wrap: wrap;
}
.gr-label { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; color: var(--text4); padding-left: 0.8rem; border-left: 1.5px solid var(--border); }
.fb {
  padding: 0.44rem 1.15rem; border-radius: 50px;
  border: 1.5px solid var(--border);
  background: var(--bg); color: var(--text2);
  font-family: 'Heebo', sans-serif; font-size: 0.82rem; font-weight: 600;
  cursor: pointer; transition: all 0.16s; white-space: nowrap;
}
.fb:hover { background: #dce6f8; color: var(--navy); border-color: #b0c4e8; }
.fb.active { background: var(--navy); border-color: var(--navy); color: #fff; font-weight: 800; box-shadow: 0 2px 12px rgba(21,40,71,0.22); }

/* MAIN CARD */
.main-card {
  background: var(--white); border-radius: 22px;
  box-shadow: 0 4px 24px rgba(21,40,71,0.10);
  overflow: hidden;
}

/* CARD HEADER */
.card-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 1.5rem 2rem; border-bottom: 1px solid var(--border);
  flex-wrap: wrap; gap: 0.8rem;
  background: linear-gradient(135deg, #f8faff 0%, #fff 100%);
}
.card-head-left h2 { font-size: 1.05rem; font-weight: 800; color: var(--navy); }
.card-head-left p { font-size: 0.74rem; color: var(--text3); margin-top: 0.15rem; }
.legend { display: flex; gap: 1.2rem; flex-wrap: wrap; align-items: center; }
.leg { display: flex; align-items: center; gap: 0.45rem; font-size: 0.75rem; font-weight: 600; color: var(--text2); }
.lsq { width: 11px; height: 11px; border-radius: 3px; flex-shrink: 0; }

/* CHART AREA */
.chart-area { padding: 1.8rem 2rem; display: grid; grid-template-columns: 1.6fr 1fr; gap: 1.5rem; align-items: start; }
@media(max-width: 900px) { .chart-area { grid-template-columns: 1fr; } }
.chart-wrap { position: relative; height: 380px; }
.pie-wrap { position: relative; height: 380px; }
.pie-box { background: var(--bg); border: 1px solid var(--border); border-radius: 14px; padding: 1.3rem; }
.pie-title { font-size: 0.82rem; font-weight: 800; color: var(--navy); margin-bottom: 0.2rem; }
.pie-sub { font-size: 0.7rem; color: var(--text3); margin-bottom: 1rem; }

/* SUMMARY ROW (mini KPIs under chart) */
.mini-kpis {
  display: flex; gap: 1px; border-top: 1px solid var(--border);
  background: var(--border);
}
.mk {
  flex: 1; background: var(--white); padding: 1rem 1.3rem;
  display: flex; flex-direction: column; gap: 0.2rem;
  transition: background 0.13s;
}
.mk:hover { background: #f8faff; }
.mk-lbl { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text4); }
.mk-val { font-size: 1.15rem; font-weight: 900; color: var(--text); letter-spacing: -0.3px; }
.mk-pct { font-size: 0.72rem; font-weight: 700; }

/* TABLE */
.table-section { padding: 2rem; }
.ts-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem; }
.ts-title { font-size: 0.9rem; font-weight: 800; color: var(--navy); }
.ts-sub { font-size: 0.72rem; color: var(--text3); margin-top: 0.1rem; }

.tbl-box { border: 1.5px solid var(--border); border-radius: 14px; overflow: hidden; }
table { width: 100%; border-collapse: collapse; }
thead tr { background: var(--navy); }
th {
  padding: 0.82rem 1rem; text-align: right;
  font-size: 0.67rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
  color: rgba(255,255,255,0.7); white-space: nowrap;
}
th.tc { text-align: center; }
tbody tr { border-bottom: 1px solid var(--border); transition: background 0.12s; }
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: #f0f5ff; }
td { padding: 0.82rem 1rem; font-size: 0.82rem; white-space: nowrap; vertical-align: middle; }

.t-name { display: flex; align-items: center; gap: 0.5rem; font-weight: 700; color: var(--text); }
.t-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
.t-num { text-align: left; font-variant-numeric: tabular-nums; color: var(--text2); font-weight: 600; }
.tc { text-align: center; }

/* Inline bar */
.ibar-wrap { display: flex; align-items: center; gap: 0.7rem; min-width: 180px; }
.ibar-track { flex: 1; height: 8px; border-radius: 4px; background: #e5eaf5; overflow: hidden; display: flex; }
.ibar-seg { height: 100%; transition: width 0.6s ease; }

.chip { display: inline-flex; align-items: center; padding: 0.2rem 0.7rem; border-radius: 50px; font-size: 0.72rem; font-weight: 800; }
.cg { background: #ecfdf5; color: #065f46; }
.cw { background: #fffbeb; color: #92400e; }
.cb { background: #fef2f2; color: #991b1b; }

/* INSIGHT BOX */
.insights { margin: 0 2rem 2rem; }
.insight-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 1rem; }
@media(max-width:800px){ .insight-grid{grid-template-columns:1fr} }
.insight-card {
  border-radius: 12px; padding: 1.1rem 1.2rem;
  border: 1.5px solid transparent; display: flex; gap: 0.8rem; align-items: flex-start;
}
.ic-icon { font-size: 1.3rem; flex-shrink: 0; margin-top: 0.05rem; }
.ic-title { font-size: 0.78rem; font-weight: 800; margin-bottom: 0.2rem; }
.ic-body { font-size: 0.73rem; line-height: 1.55; }
.ic-green { background: #f0fdf4; border-color: #bbf7d0; color: #14532d; }
.ic-red { background: #fef2f2; border-color: #fecaca; color: #7f1d1d; }
.ic-blue { background: #eff6ff; border-color: #bfdbfe; color: #1e3a8a; }

footer { text-align: center; padding: 1.8rem 0 1.2rem; color: var(--text4); font-size: 0.7rem; border-top: 1px solid var(--border); margin: 0 2rem; }

/* â•â•â•â•â•â•â•â•â•â•â• DECISION HEADER â•â•â•â•â•â•â•â•â•â•â• */
.decision-header {
  background: linear-gradient(135deg,#0f1e38 0%,#152847 50%,#1a3560 100%);
  padding: 1.8rem 2.5rem 1.5rem; position: relative; overflow: hidden;
}
.decision-header::before {
  content:''; position:absolute; inset:0;
  background: radial-gradient(ellipse at 30% 50%, rgba(59,111,212,0.15) 0%, transparent 70%);
  pointer-events:none;
}
.dh-label { font-size:0.65rem; font-weight:800; letter-spacing:2px; text-transform:uppercase; color:rgba(255,255,255,0.45); margin-bottom:0.4rem; }
.dh-title { font-family:'Playfair Display',serif; font-size:1.5rem; color:#fff; font-weight:700; margin-bottom:0.25rem; }
.dh-sub   { font-size:0.78rem; color:rgba(255,255,255,0.55); }
.insight-cards { display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-top:1.4rem; }
@media(max-width:900px){ .insight-cards{grid-template-columns:1fr} }
.ic {
  background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
  border-radius:14px; padding:1.2rem 1.3rem; position:relative; overflow:hidden;
  cursor:pointer; transition:all .2s;
}
.ic:hover { background:rgba(255,255,255,0.1); transform:translateY(-2px); }
.ic::before { content:''; position:absolute; top:0; right:0; left:0; height:3px; background:var(--ic-color); }
.ic-badge {
  display:inline-flex; align-items:center; gap:0.3rem;
  font-size:0.62rem; font-weight:800; letter-spacing:1px; text-transform:uppercase;
  color:var(--ic-color); background:rgba(255,255,255,0.08); border:1px solid var(--ic-color);
  padding:0.2rem 0.6rem; border-radius:50px; margin-bottom:0.6rem;
}
.ic-who { font-size:1rem; font-weight:800; color:#fff; margin-bottom:0.2rem; }
.ic-what { font-size:0.74rem; color:rgba(255,255,255,0.65); margin-bottom:0.7rem; line-height:1.5; }
.ic-drivers {
  font-size:0.68rem; color:rgba(255,255,255,0.5); margin-bottom:0.85rem;
  line-height:1.6; background:rgba(0,0,0,0.15); border-radius:8px; padding:0.5rem 0.7rem;
}
.ic-cta {
  display:inline-flex; align-items:center; gap:0.4rem;
  padding:0.42rem 1rem; border-radius:50px; border:none;
  background:var(--ic-color); color:#fff;
  font-family:'Heebo',sans-serif; font-size:0.75rem; font-weight:800;
  cursor:pointer; transition:all .15s; opacity:0.9;
}
.ic-cta:hover { opacity:1; transform:translateX(-2px); }

/* â•â•â•â•â•â•â•â•â•â•â• LEADERBOARD â•â•â•â•â•â•â•â•â•â•â• */
.lb-section {
  margin: 0 2rem 0; border-top: 2px solid var(--border); padding: 2rem 0;
}
.lb-head { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.8rem; margin-bottom:1.2rem; }
.lb-title { font-family:'Playfair Display',serif; font-size:1.05rem; font-weight:700; color:var(--navy); }
.lb-controls { display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap; }
.lb-search {
  padding:0.45rem 0.9rem; border-radius:50px; border:1.5px solid var(--border);
  font-family:'Heebo',sans-serif; font-size:0.8rem; outline:none; direction:rtl;
  min-width:160px; background:var(--white);
}
.lb-search:focus { border-color:var(--navy); }
.lb-ftab {
  padding:0.38rem 0.85rem; border-radius:50px; border:1.5px solid var(--border);
  background:var(--white); font-family:'Heebo',sans-serif; font-size:0.75rem; font-weight:700;
  color:var(--text3); cursor:pointer; transition:all .15s;
}
.lb-ftab.active { background:var(--navy); border-color:var(--navy); color:#fff; }
.lb-wrap { border-radius:14px; overflow:hidden; box-shadow:var(--shadow); border:1px solid var(--border); }
.lb-table { width:100%; border-collapse:collapse; }
.lb-table thead tr { background:var(--navy); }
.lb-table th {
  padding:0.7rem 1rem; font-size:0.63rem; font-weight:800; letter-spacing:1.2px;
  text-transform:uppercase; color:rgba(255,255,255,0.65); text-align:right;
  white-space:nowrap; cursor:pointer; user-select:none; transition:color .15s;
}
.lb-table th:hover { color:#fff; }
.lb-table th .sort-icon { opacity:0.35; margin-right:0.3rem; font-size:0.6rem; }
.lb-table th.sorted .sort-icon { opacity:1; color:#60a5fa; }
.lb-table td { padding:0.75rem 1rem; font-size:0.82rem; border-bottom:1px solid var(--border); white-space:nowrap; }
.lb-table tbody tr { cursor:pointer; transition:background .12s; }
.lb-table tbody tr:last-child td { border-bottom:none; }
.lb-table tbody tr:hover { background:#eff6ff; }
.lb-table tbody tr.selected { background:#dbeafe; }
.lb-entity-name { display:flex; align-items:center; gap:0.5rem; font-weight:800; color:var(--navy); }
.lb-dot { width:9px; height:9px; border-radius:50%; flex-shrink:0; }
.lb-badge { display:inline-flex; align-items:center; padding:0.18rem 0.6rem; border-radius:50px; font-size:0.65rem; font-weight:800; }
.lb-badge.good     { background:#dcfce7; color:#15803d; }
.lb-badge.watch    { background:#fef9c3; color:#a16207; }
.lb-badge.critical { background:#fee2e2; color:#b91c1c; }
.lb-sparkline { display:inline-block; }
.mom-chip { font-size:0.72rem; font-weight:800; padding:0.15rem 0.45rem; border-radius:4px; }
.mom-chip.up   { background:#dcfce7; color:#15803d; }
.mom-chip.down { background:#fee2e2; color:#b91c1c; }
.mom-chip.flat { background:#f1f5f9; color:#64748b; }

/* â•â•â•â•â•â•â•â•â•â•â• DRILLDOWN PANEL â•â•â•â•â•â•â•â•â•â•â• */
.dd-overlay {
  position:fixed; inset:0; z-index:7500;
  background:rgba(15,30,56,0.6); backdrop-filter:blur(4px);
  display:flex; align-items:stretch; justify-content:flex-start;
}
.dd-panel {
  width:min(680px,100vw); height:100vh; overflow-y:auto;
  background:var(--white); box-shadow:-8px 0 40px rgba(0,0,0,0.25);
  display:flex; flex-direction:column; animation:slideInRight .28s ease;
}
@keyframes slideInRight { from{transform:translateX(-40px);opacity:0} to{transform:translateX(0);opacity:1} }
.dd-top {
  background:linear-gradient(135deg,#152847,#1e3a5f);
  padding:1.4rem 1.6rem; position:sticky; top:0; z-index:10;
  display:flex; align-items:flex-start; justify-content:space-between;
}
.dd-close {
  background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2);
  color:#fff; font-size:1rem; padding:0.35rem 0.75rem; border-radius:8px;
  cursor:pointer; font-family:'Heebo',sans-serif; flex-shrink:0;
}
.dd-entity { font-family:'Playfair Display',serif; font-size:1.2rem; color:#fff; font-weight:700; }
.dd-entity-sub { font-size:0.72rem; color:rgba(255,255,255,0.5); margin-top:0.2rem; }
.dd-body { padding:1.4rem 1.6rem; flex:1; }
.dd-section { margin-bottom:1.8rem; }
.dd-section-title { font-size:0.65rem; font-weight:800; letter-spacing:1.5px; text-transform:uppercase; color:var(--text3); margin-bottom:0.9rem; padding-bottom:0.4rem; border-bottom:1px solid var(--border); }
.kpi-row { display:grid; grid-template-columns:repeat(3,1fr); gap:0.75rem; }
@media(max-width:500px){ .kpi-row{grid-template-columns:1fr 1fr} }
.kpi-box { background:var(--bg); border-radius:10px; padding:0.85rem; border:1px solid var(--border); }
.kpi-box-label { font-size:0.62rem; font-weight:700; color:var(--text4); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:0.3rem; }
.kpi-box-val   { font-size:1.15rem; font-weight:900; letter-spacing:-0.5px; color:var(--navy); }
.kpi-box-delta { font-size:0.68rem; font-weight:700; margin-top:0.2rem; }
.kpi-box-delta.up   { color:#059669; }
.kpi-box-delta.down { color:#dc2626; }
.norm-toggles { display:flex; gap:0.4rem; margin-bottom:1rem; }
.ntog {
  padding:0.32rem 0.8rem; border-radius:6px; border:1.5px solid var(--border);
  background:var(--white); font-family:'Heebo',sans-serif; font-size:0.73rem; font-weight:700;
  color:var(--text3); cursor:pointer; transition:all .15s;
}
.ntog.active { background:var(--navy); border-color:var(--navy); color:#fff; }
.ntog:disabled { opacity:0.4; cursor:not-allowed; }
.wf-bar-pos { background:#059669; border-radius:3px; height:28px; display:flex; align-items:center; padding:0 0.5rem; }
.wf-bar-neg { background:#dc2626; border-radius:3px; height:28px; display:flex; align-items:center; padding:0 0.5rem; }
.wf-row { display:flex; align-items:center; gap:0.6rem; margin-bottom:0.5rem; font-size:0.78rem; }
.wf-label { width:130px; flex-shrink:0; font-weight:600; color:var(--text2); text-align:right; }
.wf-track { flex:1; position:relative; height:28px; background:#f1f5f9; border-radius:3px; overflow:hidden; }
.wf-fill  { position:absolute; top:0; height:100%; border-radius:3px; transition:width .6s ease; }
.wf-val   { font-size:0.7rem; font-weight:800; color:var(--text); flex-shrink:0; min-width:65px; text-align:left; }

/* â•â•â•â•â•â•â•â•â•â•â• ENHANCED ALERTS â•â•â•â•â•â•â•â•â•â•â• */
.alerts-section {
  margin: 0 2rem 0; border-top: 2px solid var(--border); padding: 2rem 0;
}
.alert-list { display:flex; flex-direction:column; gap:0.6rem; }
.alert-card {
  display:flex; align-items:flex-start; gap:0.9rem;
  background:var(--white); border:1.5px solid var(--border); border-radius:12px;
  padding:0.9rem 1.1rem; border-right:4px solid var(--ac);
}
.alert-card.sev-high   { --ac:#dc2626; }
.alert-card.sev-medium { --ac:#f59e0b; }
.alert-card.sev-info   { --ac:#0891b2; }
.alert-card.sev-good   { --ac:#059669; }
.ac-icon { font-size:1.1rem; flex-shrink:0; margin-top:0.05rem; }
.ac-body { flex:1; }
.ac-title { font-size:0.82rem; font-weight:800; color:var(--navy); margin-bottom:0.2rem; }
.ac-desc  { font-size:0.74rem; color:var(--text3); line-height:1.5; }
.ac-meta  { font-size:0.65rem; color:var(--text4); margin-top:0.3rem; font-style:italic; }
.ac-small-base { display:inline-flex; align-items:center; gap:0.25rem; margin-right:0.4rem; padding:0.12rem 0.45rem; background:#fef9c3; border:1px solid #fde047; border-radius:4px; font-size:0.63rem; font-weight:700; color:#854d0e; }


.custom-section {
  margin: 0 2rem 0;
  border-top: 2px dashed var(--border);
  padding: 2rem 0 2rem;
}
.cs-head {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.8rem;
}
.cs-title { font-size: 1rem; font-weight: 800; color: var(--navy); }
.cs-sub   { font-size: 0.72rem; color: var(--text3); margin-top: 0.15rem; }
.cs-run-btn {
  background: var(--navy); color: #fff;
  padding: 0.6rem 1.5rem; border-radius: 50px; border: none;
  font-family: 'Heebo', sans-serif; font-size: 0.85rem; font-weight: 700;
  cursor: pointer; transition: all 0.18s;
  box-shadow: 0 2px 12px rgba(21,40,71,0.25);
}
.cs-run-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(21,40,71,0.35); }

.cs-selectors {
  display: grid; grid-template-columns: 1fr 1fr 1fr auto;
  gap: 1.2rem; margin-bottom: 1.5rem;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 16px; padding: 1.4rem;
}
@media(max-width:1000px){ .cs-selectors{ grid-template-columns: 1fr 1fr; } }
@media(max-width:640px){  .cs-selectors{ grid-template-columns: 1fr; } }

.cs-col-title {
  font-size: 0.68rem; font-weight: 800; letter-spacing: 1.2px;
  text-transform: uppercase; color: var(--text3);
  margin-bottom: 0.7rem;
}
.cs-chips { display: flex; flex-wrap: wrap; gap: 0.4rem; }
.sch {
  padding: 0.32rem 0.85rem; border-radius: 50px;
  border: 1.5px solid var(--border2);
  background: var(--white); color: var(--text3);
  font-family: 'Heebo', sans-serif; font-size: 0.76rem; font-weight: 600;
  cursor: pointer; transition: all 0.15s;
}
.sch:hover { border-color: var(--navy); color: var(--navy); }
.sch.active {
  background: var(--navy); border-color: var(--navy);
  color: #fff;
}
.cs-select {
  padding: 0.5rem 0.75rem; border-radius: 8px;
  border: 1.5px solid var(--border); background: var(--white);
  font-family: 'Heebo', sans-serif; font-size: 0.82rem; font-weight: 600;
  color: var(--navy); cursor: pointer; flex: 1;
  -webkit-appearance: none; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23152847'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: left 8px center;
  padding-left: 1.5rem;
}
.cs-select:focus { outline: none; border-color: var(--navy); }
.cs-range-btn {
  padding: 0.38rem 0.8rem; border-radius: 8px;
  border: 1.5px solid var(--border2); background: var(--bg);
  font-family: 'Heebo', sans-serif; font-size: 0.73rem; font-weight: 700;
  color: var(--text3); cursor: pointer; transition: all 0.15s; text-align: center;
}
.cs-range-btn:hover { border-color: var(--navy); color: var(--navy); background: #eff6ff; }


.cs-col-sm { min-width: 170px; }
.cs-metrics { display: flex; flex-direction: column; gap: 0.35rem; }
.smb {
  padding: 0.38rem 0.9rem; border-radius: 8px;
  border: 1.5px solid var(--border); background: var(--white);
  color: var(--text3); font-family: 'Heebo', sans-serif;
  font-size: 0.76rem; font-weight: 600; cursor: pointer;
  text-align: right; transition: all 0.15s;
}
.smb:hover { border-color: var(--navy); color: var(--navy); }
.smb.active { background: var(--navy); border-color: var(--navy); color: #fff; }

/* Results */
.cs-results {
  background: var(--white); border: 1px solid var(--border);
  border-radius: 16px; overflow: hidden;
  box-shadow: var(--shadow); margin-top: 0.5rem;
}
.cs-result-head {
  padding: 1.1rem 1.5rem; border-bottom: 1px solid var(--border);
  background: linear-gradient(135deg, #eff6ff, #fff);
  font-size: 0.82rem; font-weight: 700; color: var(--navy);
}
.cs-charts-row {
  display: grid; grid-template-columns: 1.3fr 1fr; gap: 0;
  border-bottom: 1px solid var(--border);
}
@media(max-width:900px){ .cs-charts-row{ grid-template-columns: 1fr; } }
.cs-chart-box { padding: 1.4rem; border-left: 1px solid var(--border); }
.cs-chart-box:last-child { border-left: none; }
.cs-chart-label { font-size: 0.75rem; font-weight: 700; color: var(--text3); margin-bottom: 0.9rem; }
.cs-table-wrap { overflow-x: auto; }
.cs-table-wrap table { width: 100%; border-collapse: collapse; }
.cs-table-wrap thead tr { background: var(--navy); }
.cs-table-wrap th { padding: 0.75rem 1rem; font-size: 0.67rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: rgba(255,255,255,0.7); text-align: right; white-space: nowrap; }
.cs-table-wrap td { padding: 0.8rem 1rem; font-size: 0.81rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
.cs-table-wrap tbody tr:last-child td { border-bottom: none; }
.cs-status {
  font-size: 0.78rem; font-weight: 600; color: var(--text3);
  background: var(--bg); border: 1px solid var(--border);
  padding: 0.45rem 1.1rem; border-radius: 50px;
}
.cs-status.cs-status-active {
  background: #ecfdf5; border-color: #a7f3d0; color: #065f46; font-weight: 700;
}
.cs-empty {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 3rem 2rem; text-align: center;
  background: var(--bg); border: 2px dashed var(--border);
  border-radius: 16px; margin-top: 0.5rem;
}
.cs-empty-icon { font-size: 2.5rem; margin-bottom: 0.8rem; opacity: 0.4; }
.cs-empty-title { font-size: 0.95rem; font-weight: 700; color: var(--text3); margin-bottom: 0.4rem; }
.cs-empty-sub { font-size: 0.78rem; color: var(--text4); max-width: 320px; line-height: 1.6; }



/* â”€â”€â”€ BRANCH COMPARISON â”€â”€â”€ */
.comparison-section {
  margin: 0 2rem 0;
  border-top: 1px solid var(--border);
  padding: 2rem 0 2rem;
}
.comp-head {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.8rem;
}
.comp-title { font-size: 1rem; font-weight: 800; color: var(--navy); }
.comp-sub   { font-size: 0.72rem; color: var(--text3); margin-top: 0.15rem; }
.comp-tabs  { display: flex; gap: 0.4rem; flex-wrap: wrap; }
.ctab {
  padding: 0.38rem 1rem; border-radius: 50px; border: 1px solid var(--border);
  background: var(--bg); color: var(--text3);
  font-family: 'Heebo', sans-serif; font-size: 0.78rem; font-weight: 600;
  cursor: pointer; transition: all 0.15s;
}
.ctab:hover { border-color: var(--navy); color: var(--navy); }
.ctab.active { background: var(--navy); border-color: var(--navy); color: #fff; }

/* Branch cards */
.comp-grid {
  display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;
}
@media(max-width:1100px){ .comp-grid{ grid-template-columns: repeat(3,1fr) } }
@media(max-width:640px){  .comp-grid{ grid-template-columns: repeat(2,1fr) } }

.comp-card {
  border-radius: 14px; border: 1.5px solid var(--border);
  background: var(--white); padding: 1.2rem 1.1rem;
  box-shadow: var(--shadow); position: relative; overflow: hidden;
  transition: transform 0.18s, box-shadow 0.18s;
}
.comp-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
.comp-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
  background: var(--cc);
}
.cc-name { font-size: 0.78rem; font-weight: 800; color: var(--text); margin-bottom: 0.7rem; display: flex; align-items: center; gap: 0.45rem; }
.cc-dot  { width: 9px; height: 9px; border-radius: 50%; background: var(--cc); flex-shrink: 0; }
.cc-big  { font-size: 1.7rem; font-weight: 900; letter-spacing: -0.5px; color: var(--ccol); line-height: 1; }
.cc-lbl  { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text4); margin-top: 0.3rem; }
.cc-bar-wrap { margin-top: 0.8rem; }
.cc-bar-track { height: 6px; border-radius: 3px; background: #e8eef5; overflow: hidden; }
.cc-bar-fill  { height: 100%; border-radius: 3px; background: var(--cc); transition: width 0.7s cubic-bezier(.4,0,.2,1); }
.cc-bar-sub   { font-size: 0.67rem; color: var(--text4); margin-top: 0.3rem; font-weight: 500; }
.cc-rank {
  position: absolute; top: 0.7rem; left: 0.8rem;
  width: 20px; height: 20px; border-radius: 50%;
  background: var(--cc); color: #fff;
  font-size: 0.65rem; font-weight: 900;
  display: flex; align-items: center; justify-content: center;
}

/* Comparison chart */
.comp-chart-wrap {
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 14px; padding: 1.4rem 1.5rem;
  min-height: 340px;
}

</style>
</head>
<body>

<!-- PASSWORD OVERLAY -->
<div id="gate">
  <div class="gate-box">
    <div class="gate-logo">ğŸ¥</div>
    <div class="gate-title">MedNet Analytics</div>
    <div class="gate-sub">INVESTOR PORTAL â€¢ CONFIDENTIAL</div>
    <label class="gate-label" for="pwInput">×¡×™×¡××”</label>
    <input id="pwInput" class="gate-input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off" autofocus />
    <button class="gate-btn" onclick="checkPassword()">×›× ×™×¡×” ×œ××¢×¨×›×ª â†’</button>
    <div class="gate-err" id="pwErr"></div>
    <div class="gate-conf">ğŸ”’ ××•×¦×¤×Ÿ ×•×××•×‘×˜×—</div>
  </div>
</div>

<div class="top-band">
  <div class="band-inner">
    <!-- NAV -->
    <div class="band-nav">
      <div class="brand">
        <div class="brand-mk">ğŸ¥</div>
        <div>
          <div class="brand-nm">MedNet</div>
          <div class="brand-sb">Investor Platform</div>
        </div>
      </div>
      <div class="nav-right">
        <div class="nav-pill">ğŸ“… ××•×’×³ 2025 â€” ×™× ×•×³ 2026</div>
        <button class="nav-btn nav-btn-upload" onclick="openUploadGate()">ğŸ“‚ ×”×¢×œ×” ×§×•×‘×¥</button>
      </div>
    </div>

    <!-- TITLE -->
    <div class="band-title">
      <div class="band-eye">Revenue Distribution Analysis</div>
      <h1>×”×ª×¤×œ×’×•×ª ×”×›× ×¡×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”</h1>
      <p>×‘×—×¨ ×§×‘×•×¦×” ×œ×¦×¤×™×™×” ×‘×¤×™×¨×•×˜ â€” ×›×œ ×¢××•×“×” = 100% ××”×›× ×¡×•×ª ××•×ª×• ×¡× ×™×£/××—×œ×§×”</p>
    </div>
  </div>
</div>

<!-- FILTER BAR â€” outside the blue band -->
<div style="background:#fff; border-bottom:1px solid #e0e8f5; box-shadow:0 2px 8px rgba(21,40,71,0.06);">
  <div style="max-width:1300px;margin:0 auto;padding:0.9rem 2.5rem;">
    <div class="filter-row">
      <button class="fb active" onclick="setGroup('network', this)">ğŸŒ ×›×œ ×”×¨×©×ª</button>
      <div class="gr-label">×¡× ×™×¤×™×</div>
      <button class="fb" onclick="setGroup('kfar', this)">×›×¤×¨ ×¡×‘×</button>
      <button class="fb" onclick="setGroup('rehovot', this)">×¨×—×•×‘×•×ª</button>
      <button class="fb" onclick="setGroup('bs', this)">×‘××¨ ×©×‘×¢</button>
      <button class="fb" onclick="setGroup('haifa', this)">×—×™×¤×”</button>
      <button class="fb" onclick="setGroup('motzkin', this)">××•×¦×§×™×Ÿ</button>
      <div class="gr-label">××—×œ×§×•×ª</div>
      <button class="fb" onclick="setGroup('depts', this)">×›×œ ×”××—×œ×§×•×ª</button>
      <button class="fb" onclick="setGroup('chirum', this)">×—×™×¨×•×</button>
      <button class="fb" onclick="setGroup('neuro', this)">× ×•×™×¨×•×œ×•×’×™×”</button>
      <button class="fb" onclick="setGroup('imaging', this)">×”×“××™×”</button>
      <button class="fb" onclick="setGroup('surgery', this)">×›×™×¨×•×¨×’×™×”</button>
      <button class="fb" onclick="setGroup('cardio', this)">×§×¨×“×™×•×œ×•×’×™×”</button>
      <button class="fb" onclick="setGroup('onco', this)">××•× ×§×•×œ×•×’×™×”</button>
      <button class="fb" onclick="setGroup('anest', this)">×”×¨×“××”</button>
    </div>
  </div>
</div>

<!-- UPLOAD PASSWORD MODAL -->
<div id="uploadGate" class="modal-overlay modal-hidden">
  <div class="modal-box" style="max-width:380px;text-align:center;position:relative">
    <div style="width:52px;height:52px;border-radius:14px;background:#eff6ff;border:1.5px solid #bfdbfe;display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin:0 auto 1.2rem">ğŸ“‚</div>
    <div style="font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:#152847;margin-bottom:0.3rem">×”×¢×œ××ª ×§×•×‘×¥</div>
    <div style="font-size:0.76rem;color:#6b7280;margin-bottom:1.6rem">×”×–×Ÿ ×¡×™×¡××ª × ×™×”×•×œ ×œ×”××©×š</div>
    <label style="display:block;font-size:0.68rem;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:#94a3b8;text-align:right;margin-bottom:0.45rem">×¡×™×¡××”</label>
    <input id="uploadPwInput" type="password" placeholder="â€¢â€¢â€¢â€¢" autocomplete="off"
      style="-webkit-text-security:disc;width:100%;padding:0.8rem 1rem;border-radius:10px;border:1.5px solid #e0e8f5;font-family:'Heebo',sans-serif;font-size:1rem;outline:none;text-align:right;letter-spacing:3px;margin-bottom:1rem;transition:border-color .2s;-webkit-appearance:none;appearance:none"
      onkeydown="if(event.key==='Enter')checkUploadPw();document.getElementById('uploadPwErr').textContent=''" />
    <button onclick="checkUploadPw()" style="width:100%;padding:0.85rem;border-radius:10px;border:none;background:#152847;color:#fff;font-family:'Heebo',sans-serif;font-size:0.92rem;font-weight:800;cursor:pointer;-webkit-tap-highlight-color:transparent;touch-action:manipulation">×××ª ×¡×™×¡××” â†’</button>
    <div id="uploadPwErr" style="margin-top:0.8rem;font-size:0.76rem;color:#dc2626;font-weight:600;min-height:1.2em"></div>
    <button onclick="closeUploadGate()" style="position:absolute;top:1rem;left:1rem;background:none;border:none;font-size:1.3rem;cursor:pointer;color:#94a3b8;line-height:1;padding:0.4rem;-webkit-tap-highlight-color:transparent">âœ•</button>
  </div>
</div>

<!-- UPLOAD FILE PICKER (hidden) -->
<input id="uploadFileInput" type="file" accept=".xlsx,.xls,.csv,.numbers" style="position:absolute;width:1px;height:1px;opacity:0;overflow:hidden" onchange="handleFileUpload(event)" />

<!-- FILE DATA VIEWER MODAL -->
<div id="fileViewer" class="modal-overlay modal-hidden" style="align-items:flex-start;overflow-y:auto;padding:2rem">
  <div style="background:#fff;border-radius:20px;width:100%;max-width:1200px;margin:0 auto;box-shadow:0 24px 80px rgba(0,0,0,0.35);overflow:hidden;animation:popIn .3s ease">
    <!-- Header -->
    <div style="background:linear-gradient(135deg,#152847,#1e3a5f);padding:1.3rem 1.8rem;display:flex;align-items:center;justify-content:space-between">
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:#fff;font-weight:700" id="fvTitle">×’×œ×™×•×Ÿ × ×ª×•× ×™×</div>
        <div style="font-size:0.72rem;color:rgba(255,255,255,0.55);margin-top:0.2rem" id="fvMeta"></div>
      </div>
      <button onclick="closeFileViewer()" style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);color:#fff;font-size:0.82rem;font-weight:700;padding:0.4rem 1rem;border-radius:50px;cursor:pointer;font-family:'Heebo',sans-serif">âœ• ×¡×’×•×¨</button>
    </div>
    <!-- Search + info bar -->
    <div style="padding:1rem 1.8rem;border-bottom:1px solid #e0e8f5;display:flex;align-items:center;gap:1rem;flex-wrap:wrap;background:#f8faff">
      <input id="fvSearch" type="text" placeholder="ğŸ” ×—×™×¤×•×© ×‘× ×ª×•× ×™×..." oninput="filterFvTable()"
        style="padding:0.55rem 1rem;border-radius:50px;border:1.5px solid #e0e8f5;font-family:'Heebo',sans-serif;font-size:0.83rem;outline:none;min-width:220px;direction:rtl" />
      <div style="font-size:0.75rem;color:#6b7280;font-weight:500" id="fvCount"></div>
      <div style="margin-right:auto;display:flex;gap:0.5rem" id="fvSheetTabs"></div>
    </div>
    <!-- Table -->
    <div style="overflow:auto;max-height:60vh">
      <table id="fvTable" style="width:100%;border-collapse:collapse;font-size:0.81rem"></table>
    </div>
  </div>
</div>

<!-- DRILLDOWN PANEL -->
<div id="ddOverlay" class="dd-overlay modal-hidden" onclick="if(event.target===this)closeDrilldown()">
  <div class="dd-panel" id="ddPanel">
    <div class="dd-top">
      <div>
        <div class="dd-entity" id="ddEntityName">â€”</div>
        <div class="dd-entity-sub" id="ddEntitySub">â€”</div>
      </div>
      <button class="dd-close" onclick="closeDrilldown()">âœ• ×¡×’×•×¨</button>
    </div>
    <div class="dd-body">
      <!-- KPI comparison -->
      <div class="dd-section">
        <div class="dd-section-title">ğŸ“Š ×”×©×•×•××ª KPI â€” ×ª×§×•×¤×” × ×•×›×—×™×ª ××•×œ ×§×•×“××ª ××•×œ ×××•×¦×¢ ×¨×©×ª</div>
        <div class="kpi-row" id="ddKpiRow"></div>
      </div>
      <!-- Normalization -->
      <div class="dd-section">
        <div class="dd-section-title">ğŸ”€ Waterfall â€” ×¤×™×¨×•×§ ×©×™× ×•×™ ×—×•×“×©×™</div>
        <div class="norm-toggles">
          <button class="ntog active" data-norm="abs" onclick="setNorm(this)">â‚ª ××•×—×œ×˜</button>
          <button class="ntog" data-norm="pct" onclick="setNorm(this)">% ××”×›× ×¡×•×ª</button>
          <button class="ntog" data-norm="unit" onclick="setNorm(this)" disabled title="× ×“×¨×©×™× × ×ª×•× ×™ ×™×—×™×“×•×ª â€” ×œ× ×–××™×Ÿ">×¤×¨ ×™×—×™×“×”</button>
        </div>
        <div id="ddWaterfall"></div>
      </div>
      <!-- Monthly trend -->
      <div class="dd-section">
        <div class="dd-section-title">ğŸ“ˆ ××’××” ×—×•×“×©×™×ª</div>
        <div style="position:relative;height:200px"><canvas id="ddTrendChart"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- MAIN CARD -->
<div style="padding: 1.5rem 2rem 0; max-width: 1350px; margin: 0 auto;">
<div class="main-card">

  <!-- CARD HEADER -->
  <div class="card-head">
    <div class="card-head-left">
      <h2 id="chartTitle">×›×œ ×”×¨×©×ª â€” ×¡× ×™×¤×™×</h2>
      <p id="chartSub">×”×ª×¤×œ×’×•×ª 100% ×©×œ ×”×›× ×¡×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×™×ª ×¢×œ×•×ª ×•×ª×¨×•××” ×™×©×™×¨×”</p>
    </div>
    <div class="legend">
      <div class="leg"><span class="lsq" style="background:var(--c-dr)"></span>×©×›×¨ ×¨×•×¤××™×</div>
      <div class="leg"><span class="lsq" style="background:var(--c-em)"></span>×©×›×¨ ×¢×•×‘×“×™×</div>
      <div class="leg"><span class="lsq" style="background:var(--c-co)"></span>×§×‘×œ× ×™ ××©× ×”</div>
      <div class="leg"><span class="lsq" style="background:var(--c-vm)"></span>×•×˜××¨×§×˜ ğŸ¾</div>
      <div class="leg"><span class="lsq" style="background:var(--c-pr)"></span>×ª×¨×•××” ×™×©×™×¨×” âœ…</div>
      <div class="leg"><span class="lsq" style="background:var(--c-lo)"></span>×”×¤×¡×“ ğŸ”´</div>
    </div>
  </div>

  <!-- CHART -->
  <div class="chart-area">
    <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
    <div class="pie-box">
      <div class="pie-title">â¬¤ ×”×ª×¤×œ×’×•×ª ×¢×œ×•×™×•×ª</div>
      <div class="pie-sub" id="pieSub">×¡×”×´×› ×”×§×‘×•×¦×” ×”× ×‘×—×¨×ª</div>
      <div class="pie-wrap"><canvas id="pieChart"></canvas></div>
    </div>
  </div>

  <!-- MINI KPIs -->
  <div class="mini-kpis" id="miniKpis"></div>

  <!-- TABLE -->
  <div class="table-section">
    <div class="ts-head">
      <div>
        <div class="ts-title">×˜×‘×œ×ª × ×ª×•× ×™× ××¤×•×¨×˜×ª</div>
        <div class="ts-sub">×¡×”×´×› 6 ×—×•×“×©×™× â€¢ ×œ×—×¥ ×¢×œ ×©×•×¨×” ×œ×¤×™×¨×•×˜</div>
      </div>
    </div>
    <div class="tbl-box">
      <div style="overflow-x:auto">
        <table>
          <thead><tr>
            <th>×©×</th>
            <th>×”×›× ×¡×•×ª</th>
            <th class="tc">ğŸ‘¨â€âš•ï¸ ×©×›×¨ ×¨×•×¤××™×</th>
            <th class="tc">ğŸ‘¥ ×©×›×¨ ×¢×•×‘×“×™×</th>
            <th class="tc">ğŸ¾ ×•×˜××¨×§×˜</th>
            <th class="tc">ğŸ”§ ×§×‘×œ× ×™ ××©× ×”</th>
            <th>×”×ª×¤×œ×’×•×ª ×¢×œ×•×™×•×ª</th>
            <th class="tc">ğŸ’š ×ª×¨×•××” ×™×©×™×¨×”</th>
            <th class="tc">××¨×•×•×— %</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- INSIGHTS -->
  <div class="insights">
    <div class="insight-grid" id="insightGrid"></div>
  </div>

  <!-- CUSTOM COMPARISON BUILDER -->
  <div class="custom-section">
    <div class="cs-head">
      <div>
        <div class="cs-title">ğŸ”¬ ×›×œ×™ ×”×©×•×•××” ××•×ª×× ××™×©×™×ª</div>
        <div class="cs-sub">×‘×—×¨ ×—×•×“×©×™× ×•××—×œ×§×•×ª/×¡× ×™×¤×™× ×œ×‘× ×™×™×ª ×”×©×•×•××” ××“×•×™×§×ª</div>
      </div>
      <div id="csStatus" class="cs-status">×‘×—×¨ ×—×•×“×©×™× ×•×™×©×•×™×•×ª ×›×“×™ ×œ×”×ª×—×™×œ</div>
    </div>

    <!-- SELECTORS ROW -->
    <div class="cs-selectors">
      <!-- Month selector â€” chip buttons -->
      <div class="cs-col">
        <div class="cs-col-title">ğŸ“… ×—×•×“×©×™×</div>
        <div id="monthChipsWrap" style="display:flex;flex-direction:column;gap:0.5rem"></div>
        <div style="display:flex;gap:0.4rem;margin-top:0.6rem">
          <button onclick="selectAllMonths()" class="cs-range-btn">âœ“ ×”×›×œ</button>
          <button onclick="clearAllMonths()" class="cs-range-btn">âœ• × ×§×”</button>
        </div>
        <div class="cs-hint" id="csMonthHint">×‘×—×¨ ×—×•×“×©×™×</div>
      </div>

      <!-- Branch selector -->
      <div class="cs-col">
        <div class="cs-col-title">ğŸ¥ ×¡× ×™×¤×™×</div>
        <div class="cs-chips" id="branchChips">
          <button class="sch" data-type="entity" data-val="×›×¤×¨ ×¡×‘×" onclick="toggleSel(this)">×›×¤×¨ ×¡×‘×</button>
          <button class="sch" data-type="entity" data-val="×¨×—×•×‘×•×ª" onclick="toggleSel(this)">×¨×—×•×‘×•×ª</button>
          <button class="sch" data-type="entity" data-val="×‘××¨ ×©×‘×¢" onclick="toggleSel(this)">×‘××¨ ×©×‘×¢</button>
          <button class="sch" data-type="entity" data-val="×—×™×¤×”" onclick="toggleSel(this)">×—×™×¤×”</button>
          <button class="sch" data-type="entity" data-val="××•×¦×§×™×Ÿ" onclick="toggleSel(this)">××•×¦×§×™×Ÿ</button>
        </div>
        <div class="cs-hint">×¡× ×™×¤×™× ×¨××©×™×™×</div>
      </div>

      <!-- Dept selector -->
      <div class="cs-col">
        <div class="cs-col-title">ğŸ”¬ ××—×œ×§×•×ª ×›×¤×¨ ×¡×‘×</div>
        <div class="cs-chips" id="deptChips">
          <button class="sch" data-type="entity" data-val="×—×™×¨×•×" onclick="toggleSel(this)">×—×™×¨×•×</button>
          <button class="sch" data-type="entity" data-val="× ×•×™×¨×•×œ×•×’×™×”" onclick="toggleSel(this)">× ×•×™×¨×•×œ×•×’×™×”</button>
          <button class="sch" data-type="entity" data-val="×”×“××™×”" onclick="toggleSel(this)">×”×“××™×”</button>
          <button class="sch" data-type="entity" data-val="×›×™×¨×•×¨×’×™×”" onclick="toggleSel(this)">×›×™×¨×•×¨×’×™×”</button>
          <button class="sch" data-type="entity" data-val="×§×¨×“×™×•×œ×•×’×™×”" onclick="toggleSel(this)">×§×¨×“×™×•×œ×•×’×™×”</button>
          <button class="sch" data-type="entity" data-val="××•× ×§×•×œ×•×’×™×”" onclick="toggleSel(this)">××•× ×§×•×œ×•×’×™×”</button>
          <button class="sch" data-type="entity" data-val="×”×¨×“××”" onclick="toggleSel(this)">×”×¨×“××”</button>
        </div>
        <div class="cs-hint">×œ×—×¥ ×œ×”×•×¡×™×£ ×œ×”×©×•×•××”</div>
      </div>

      <!-- Metric -->
      <div class="cs-col cs-col-sm">
        <div class="cs-col-title">ğŸ“ ××“×“ ×œ×”×©×•×•××”</div>
        <div class="cs-metrics" id="metricChips">
          <button class="smb active" data-metric="cont" onclick="setMetric(this)">×ª×¨×•××” ×™×©×™×¨×”</button>
          <button class="smb" data-metric="rev"  onclick="setMetric(this)">×”×›× ×¡×•×ª</button>
          <button class="smb" data-metric="dr"   onclick="setMetric(this)">×©×›×¨ ×¨×•×¤××™×</button>
          <button class="smb" data-metric="em"   onclick="setMetric(this)">×©×›×¨ ×¢×•×‘×“×™×</button>
          <button class="smb" data-metric="vm"   onclick="setMetric(this)">×•×˜××¨×§×˜</button>
          <button class="smb" data-metric="margin" onclick="setMetric(this)">××¨×•×•×— %</button>
        </div>
      </div>
    </div>

    <!-- EMPTY STATE -->
    <div id="csEmpty" class="cs-empty">
      <div class="cs-empty-icon">ğŸ“Š</div>
      <div class="cs-empty-title">×‘×—×¨ ×—×•×“×©×™× ×•×™×©×•×™×•×ª ×œ×”×©×•×•××”</div>
      <div class="cs-empty-sub">×œ×—×¥ ×¢×œ ×—×•×“×©×™× + ×¡× ×™×¤×™×/××—×œ×§×•×ª â€” ×”×ª×•×¦××•×ª ×™×•×¤×™×¢×• ×›××Ÿ ×‘××•×¤×Ÿ ××•×˜×•××˜×™</div>
    </div>

    <!-- RESULTS -->
    <div class="cs-results" id="csResults" style="display:none">
      <div class="cs-result-head" id="csResultHead"></div>
      <div class="cs-charts-row">
        <div class="cs-chart-box">
          <div class="cs-chart-label">×”×©×•×•××ª ×™×©×•×™×•×ª ×œ××•×¨×š ×—×•×“×©×™×</div>
          <div style="position:relative;height:300px"><canvas id="csLineChart"></canvas></div>
        </div>
        <div class="cs-chart-box">
          <div class="cs-chart-label">×¡×™×›×•× â€” ×××•×¦×¢ ×œ×ª×§×•×¤×” ×”× ×‘×—×¨×ª</div>
          <div style="position:relative;height:300px"><canvas id="csBarChart"></canvas></div>
        </div>
      </div>
      <!-- Result table -->
      <div class="cs-table-wrap">
        <table id="csTable">
          <thead id="csTableHead"></thead>
          <tbody id="csTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div class="lb-section">
    <div class="lb-head">
      <div>
        <div class="lb-title">ğŸ“‹ ×‘×™×¦×•×¢×™ ×›×œ ×”×™×©×•×™×•×ª</div>
        <div style="font-size:0.72rem;color:var(--text3);margin-top:0.15rem">×œ×—×¥ ×¢×œ ×©×•×¨×” ×œ×¤×ª×™×—×ª ×¤×× ×œ ×ª×—×§×™×¨ ××¤×•×¨×˜</div>
      </div>
      <div class="lb-controls">
        <input class="lb-search" id="lbSearch" placeholder="ğŸ” ×—×™×¤×•×© ×™×©×•×ª..." oninput="renderLeaderboard()" />
        <button class="lb-ftab active" onclick="setLbFilter('all',this)">×”×›×œ</button>
        <button class="lb-ftab" onclick="setLbFilter('branch',this)">×¡× ×™×¤×™×</button>
        <button class="lb-ftab" onclick="setLbFilter('dept',this)">××—×œ×§×•×ª</button>
      </div>
    </div>
    <div class="lb-wrap">
      <table class="lb-table">
        <thead>
          <tr>
            <th onclick="lbSort('name')"><span class="sort-icon">â†•</span>×™×©×•×ª</th>
            <th onclick="lbSort('rev')"><span class="sort-icon">â†•</span>×”×›× ×¡×•×ª</th>
            <th onclick="lbSort('margin')"><span class="sort-icon">â†•</span>××¨×•×•×— %</th>
            <th onclick="lbSort('cont')"><span class="sort-icon">â†•</span>×ª×¨×•××” ×™×©×™×¨×”</th>
            <th onclick="lbSort('drPct')"><span class="sort-icon">â†•</span>×©×›×¨ ×¨×•×¤××™× %</th>
            <th onclick="lbSort('mom')"><span class="sort-icon">â†•</span>×©×™× ×•×™ ×—×•×“×©×™</th>
            <th>××’××” 6 ×—×“×³</th>
            <th onclick="lbSort('status')"><span class="sort-icon">â†•</span>×¡×˜×˜×•×¡</th>
          </tr>
        </thead>
        <tbody id="lbBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ENHANCED ALERTS -->
  <div class="alerts-section">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;flex-wrap:wrap;gap:0.6rem">
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700;color:var(--navy)">ğŸ”” ××¢×¨×›×ª ×”×ª×¨××•×ª ×—×›××”</div>
        <div style="font-size:0.72rem;color:var(--text3);margin-top:0.15rem">×”×ª×¨××•×ª ×¡×£ + ×–×™×”×•×™ ×× ×•××œ×™×•×ª (z-score)</div>
      </div>
      <div style="display:flex;gap:0.4rem">
        <button class="lb-ftab active" onclick="setAlertFilter('all',this)">×”×›×œ</button>
        <button class="lb-ftab" onclick="setAlertFilter('high',this)">ğŸš¨ ×§×¨×™×˜×™</button>
        <button class="lb-ftab" onclick="setAlertFilter('medium',this)">âš ï¸ ××¢×§×‘</button>
        <button class="lb-ftab" onclick="setAlertFilter('good',this)">âœ… ×—×™×•×‘×™</button>
      </div>
    </div>
    <div class="alert-list" id="alertList"></div>
  </div>

  <!-- CEO COMMAND CENTER -->
  <div class="ceo-section">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:0.8rem;margin-bottom:1.5rem">
      <div>
        <div class="ceo-title">ğŸ¯ ×œ×•×— ×¤×™×§×•×“ â€” ×× ×›×´×œ</div>
        <div class="ceo-sub">×¡×™×›×•× ×‘×™×¦×•×¢×™×, ×”×ª×¨××•×ª ×•×›×œ×™× ×œ×§×‘×œ×ª ×”×—×œ×˜×•×ª ××”×™×¨×”</div>
      </div>
      <button onclick="refreshCEO()" style="padding:0.45rem 1.1rem;border-radius:50px;border:1.5px solid var(--border);background:var(--white);font-family:'Heebo',sans-serif;font-size:0.78rem;font-weight:700;color:var(--navy);cursor:pointer">ğŸ”„ ×¨×¢× ×Ÿ</button>
    </div>
    <div class="ceo-grid" id="ceoGrid"></div>
  </div>

  <!-- BRANCH COMPARISON -->
  <div class="comparison-section">
    <div class="comp-head">
      <div>
        <div class="comp-title">ğŸ“Š ×”×©×•×•××ª ×‘×™×¦×•×¢×™× â€” ×›×œ ×”×¡× ×™×¤×™×</div>
        <div class="comp-sub">×¡×”×´×› 6 ×—×•×“×©×™× â€¢ ××•×’×³ 2025 â€“ ×™× ×•×³ 2026</div>
      </div>
      <div class="comp-tabs" id="compTabs">
        <button class="ctab active" onclick="setCompView('revenue',this)">×”×›× ×¡×•×ª</button>
        <button class="ctab" onclick="setCompView('margin',this)">××¨×•×•×— %</button>
        <button class="ctab" onclick="setCompView('contrib',this)">×ª×¨×•××” ×™×©×™×¨×”</button>
        <button class="ctab" onclick="setCompView('dr',this)">×©×›×¨ ×¨×•×¤××™×</button>
      </div>
    </div>
    <div class="comp-grid" id="compGrid"></div>
    <div class="comp-chart-wrap">
      <div style="position:relative; height:340px;">
        <canvas id="compChart"></canvas>
      </div>
    </div>
  </div>

  <footer>MedNet Analytics â€¢ ××•×’×³ 2025 â€“ ×™× ×•×³ 2026 â€¢ Confidential</footer>
</div>
</div>

<script>
// â”€â”€â”€ DATA â”€â”€â”€
const ALL = {
  // Branches
  '×›×¤×¨ ×¡×‘×':  { type:'branch', color:'#0891b2', rev:22198992, dr:4939304, em:5113394, co:224847, vm:1150990, cont:10770457 },
  '×¨×—×•×‘×•×ª':   { type:'branch', color:'#7c3aed', rev:3901077,  dr:2327071, em:1398184, co:0,      vm:344882,  cont:-169060  },
  '×‘××¨ ×©×‘×¢':  { type:'branch', color:'#059669', rev:2522324,  dr:722968,  em:418245,  co:0,      vm:341603,  cont:1039508  },
  '×—×™×¤×”':     { type:'branch', color:'#0284c7', rev:4948841,  dr:2318511, em:997865,  co:0,      vm:474974,  cont:1157491  },
  '××•×¦×§×™×Ÿ':   { type:'branch', color:'#d97706', rev:595550,   dr:90554,   em:272195,  co:0,      vm:55292,   cont:177510   },
  // Depts
  '×—×™×¨×•×':      { type:'dept', color:'#ef4444', rev:9124098, dr:2203685, em:2407961, co:0,      vm:916009, cont:3596444  },
  '× ×•×™×¨×•×œ×•×’×™×”': { type:'dept', color:'#ec4899', rev:3514569, dr:510624,  em:443575,  co:174347, vm:83800,  cont:2302224  },
  '×”×“××™×”':      { type:'dept', color:'#14b8a6', rev:3036425, dr:432437,  em:534940,  co:50500,  vm:22508,  cont:1996039  },
  '×›×™×¨×•×¨×’×™×”':   { type:'dept', color:'#a855f7', rev:3513439, dr:428538,  em:680370,  co:0,      vm:128673, cont:2275858  },
  '×§×¨×“×™×•×œ×•×’×™×”': { type:'dept', color:'#f43f5e', rev:898692,  dr:392341,  em:38958,   co:0,      vm:0,      cont:299595  },
  '××•× ×§×•×œ×•×’×™×”': { type:'dept', color:'#f97316', rev:1121066, dr:626712,  em:0,       co:0,      vm:0,      cont:495000  },
  '×”×¨×“××”':      { type:'dept', color:'#84cc16', rev:610372,  dr:251563,  em:19424,   co:0,      vm:0,      cont:339403  },

  // Monthly dept data
  '×—×™×¨×•×_monthly': { months: {
    dr: [0, 443110, 415386, 398468, 524730, 421991],
    em: [0, 441633, 570103, 442097, 494877, 459251],
    co: [0, 0, 0, 0, 0, 0],
    vm: [0, 0, 232255, 302662, 82318, 298774],
    rev:[1526302, 1456678, 1598972, 1545136, 1429007, 1568003],
    cont:[1526302, 571935, 381228, 401909, 327082, 387988],
  }},
  '× ×•×™×¨×•×œ×•×’×™×”_monthly': { months: {
    dr: [0, 121651, 82232, 95035, 104618, 107088],
    em: [0, 72007, 85481, 91575, 93961, 100551],
    co: [0, 0, 40339, 39746, 43839, 50423],
    vm: [0, 0, 25750, 15569, 26108, 16373],
    rev:[764258, 434803, 475744, 805726, 550269, 483769],
    cont:[764258, 241145, 241942, 563801, 281744, 209334],
  }},
  '×”×“××™×”_monthly': { months: {
    dr: [0, 80367, 87452, 80906, 100337, 83375],
    em: [0, 104136, 110676, 103929, 107995, 108204],
    co: [0, 0, 13500, 10500, 12750, 13750],
    vm: [0, 0, 5609, 5777, 3228, 7894],
    rev:[473890, 478567, 464873, 531811, 560003, 527281],
    cont:[473890, 294064, 247636, 330699, 335693, 314057],
  }},
  '×›×™×¨×•×¨×’×™×”_monthly': { months: {
    dr: [0, 79061, 102525, 79509, 79626, 87817],
    em: [0, 130249, 134458, 160344, 142842, 112477],
    co: [0, 0, 0, 0, 0, 0],
    vm: [0, 0, 5432, 35296, 25613, 62332],
    rev:[561458, 443381, 592931, 639583, 620246, 655840],
    cont:[561458, 234071, 350516, 364434, 372165, 393214],
  }},
  '×§×¨×“×™×•×œ×•×’×™×”_monthly': { months: {
    dr: [0, 31568, 70731, 76089, 106568, 107385],
    em: [0, 7949, 7525, 7927, 8758, 6799],
    co: [0, 0, 0, 0, 0, 0],
    vm: [0, 0, 0, 0, 0, 0],
    rev:[167715, 93928, 111236, 164369, 177806, 183636],
    cont:[167715, 54411, 32979, 80353, 62480, 69452],
  }},
  '××•× ×§×•×œ×•×’×™×”_monthly': { months: {
    dr: [0, 0, 142356, 160730, 180991, 142634],
    em: [0, 0, 0, 0, 0, 0],
    co: [0, 0, 0, 0, 0, 0],
    vm: [0, 0, 0, 0, 0, 0],
    rev:[156231, 173355, 165306, 218676, 235970, 172527],
    cont:[156231, 173355, 22950, 57947, 54980, 29893],
  }},
  '×”×¨×“××”_monthly': { months: {
    dr: [0, 35048, 51466, 59215, 54094, 51742],
    em: [0, 3454, 2313, 4807, 3773, 5077],
    co: [0, 0, 0, 0, 0, 0],
    vm: [0, 0, 0, 0, 0, 0],
    rev:[64958, 46517, 103983, 133347, 136186, 125381],
    cont:[64958, 8015, 50204, 69325, 78319, 68562],
  }},
  '×›×¤×¨ ×¡×‘×_monthly': { months: {
    dr: [0,790805,978381,975545,1175464,1019109],
    em: [0,944588,1086804,998550,1053788,1029664],
    co: [0,0,53839,50246,56589,64173],
    vm: [0,0,269046,359304,137267,385373],
    rev:[3771427,3190723,3589999,4101214,3776818,3768811],
    cont:[3771427,1455330,1201929,1717569,1353710,1270492],
  }},
  '×¨×—×•×‘×•×ª_monthly': { months: {
    dr: [425375,356716,362125,356392,461400,365063],
    em: [231167,227730,241617,230396,250022,217252],
    co: [0,0,0,0,0,0],
    vm: [0,0,85374,86514,86480,86514],
    rev:[0,586379,870220,850423,820875,773180],
    cont:[-656541,1933,181104,177120,22973,104351],
  }},
  '×‘××¨ ×©×‘×¢_monthly': { months: {
    dr: [117201,115677,107026,99366,138179,145519],
    em: [67982,65735,69339,69932,75318,69939],
    co: [0,0,0,0,0,0],
    vm: [0,50127,85409,61107,83853,61107],
    rev:[423525,392875,375400,421733,469620,439171],
    cont:[238341,161335,113626,191329,172271,162606],
  }},
  '×—×™×¤×”_monthly': { months: {
    dr: [295955,304381,448146,429847,455672,384510],
    em: [149925,160972,210698,153073,169438,153759],
    co: [0,0,0,0,0,0],
    vm: [0,0,113036,133788,115114,113036],
    rev:[432033,869412,886831,872897,880342,1007326],
    cont:[-13847,404059,114951,156189,140118,356021],
  }},
  '××•×¦×§×™×Ÿ_monthly': { months: {
    dr: [14949,10496,15968,16105,19462,13574],
    em: [38651,32583,35213,38324,74417,53007],
    co: [0,0,0,0,0,0],
    vm: [0,9012,9686,11929,14979,9686],
    rev:[49908,94246,108673,129999,85021,127703],
    cont:[-3692,42155,47806,63641,-23837,51437],
  }},
};

const MONTHS = ['××•×’×³ 25','×¡×¤×˜×³ 25','××•×§×³ 25','× ×•×‘×³ 25','×“×¦××³ 25','×™× ×•×³ 26'];

const GROUPS = {
  network:  { title:'×›×œ ×”×¨×©×ª â€” ×¡× ×™×¤×™×', keys:['×›×¤×¨ ×¡×‘×','×¨×—×•×‘×•×ª','×‘××¨ ×©×‘×¢','×—×™×¤×”','××•×¦×§×™×Ÿ'] },
  kfar:     { title:'×›×¤×¨ ×¡×‘× â€” ×œ×¤×™ ×—×•×“×©', monthly:'×›×¤×¨ ×¡×‘×' },
  rehovot:  { title:'×¨×—×•×‘×•×ª â€” ×œ×¤×™ ×—×•×“×©',  monthly:'×¨×—×•×‘×•×ª' },
  bs:       { title:'×‘××¨ ×©×‘×¢ â€” ×œ×¤×™ ×—×•×“×©', monthly:'×‘××¨ ×©×‘×¢' },
  haifa:    { title:'×—×™×¤×” â€” ×œ×¤×™ ×—×•×“×©',    monthly:'×—×™×¤×”' },
  motzkin:  { title:'××•×¦×§×™×Ÿ â€” ×œ×¤×™ ×—×•×“×©',  monthly:'××•×¦×§×™×Ÿ' },
  depts:    { title:'××—×œ×§×•×ª ×›×¤×¨ ×¡×‘× â€” ×›×•×œ×Ÿ', keys:['×—×™×¨×•×','× ×•×™×¨×•×œ×•×’×™×”','×”×“××™×”','×›×™×¨×•×¨×’×™×”','×§×¨×“×™×•×œ×•×’×™×”','××•× ×§×•×œ×•×’×™×”','×”×¨×“××”'] },
  chirum:   { title:'×—×™×¨×•× â€” ×œ×¤×™ ×—×•×“×©',      monthly:'×—×™×¨×•×' },
  neuro:    { title:'× ×•×™×¨×•×œ×•×’×™×” â€” ×œ×¤×™ ×—×•×“×©', monthly:'× ×•×™×¨×•×œ×•×’×™×”' },
  imaging:  { title:'×”×“××™×” â€” ×œ×¤×™ ×—×•×“×©',      monthly:'×”×“××™×”' },
  surgery:  { title:'×›×™×¨×•×¨×’×™×” â€” ×œ×¤×™ ×—×•×“×©',   monthly:'×›×™×¨×•×¨×’×™×”' },
  cardio:   { title:'×§×¨×“×™×•×œ×•×’×™×” â€” ×œ×¤×™ ×—×•×“×©', monthly:'×§×¨×“×™×•×œ×•×’×™×”' },
  onco:     { title:'××•× ×§×•×œ×•×’×™×” â€” ×œ×¤×™ ×—×•×“×©', monthly:'××•× ×§×•×œ×•×’×™×”' },
  anest:    { title:'×”×¨×“××” â€” ×œ×¤×™ ×—×•×“×©',       monthly:'×”×¨×“××”' },
};

let currentGroup = 'network';
let chart = null;
let pieChart = null;

const fmt = n => {
  if (n===null||isNaN(n)) return 'â€”';
  const a = Math.abs(n);
  if (a>=1e6) return (n<0?'-':'')+'â‚ª'+(a/1e6).toFixed(2)+'M';
  if (a>=1e3) return (n<0?'-':'')+'â‚ª'+(a/1e3).toFixed(0)+'K';
  return (n<0?'-':'')+'â‚ª'+a.toFixed(0);
};
const fmtPct = (v,r) => r>0 ? (v/r*100).toFixed(1)+'%' : 'â€”';
const pn = (v,r) => r>0 ? v/r*100 : 0;
const sum = arr => arr.reduce((a,b)=>a+(b||0),0);

function buildData(gKey) {
  const g = GROUPS[gKey];
  if (g.monthly) {
    const m = ALL[g.monthly + '_monthly'].months;
    return MONTHS.map((mo, i) => ({
      name: mo, color: ALL[g.monthly].color,
      rev: m.rev[i], dr: m.dr[i], em: m.em[i], co: m.co[i], vm: m.vm[i], cont: m.cont[i]
    }));
  }
  return g.keys.map(k => ({ name: k, ...ALL[k] }));
}

function setGroup(gKey, el) {
  currentGroup = gKey;
  document.querySelectorAll('.fb').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  renderAll();
}

function renderAll() {
  const g = GROUPS[currentGroup];
  const rows = buildData(currentGroup);
  document.getElementById('chartTitle').textContent = g.title;
  renderChart(rows);
  renderPieChart(rows);
  renderMiniKpis(rows);
  renderTable(rows);
  renderInsights(rows);
}

function renderChart(rows) {
  if (chart) chart.destroy();
  const ctx = document.getElementById('mainChart').getContext('2d');

  // Build 100% stacked data
  const labels = rows.map(r => r.name);
  const colors = rows.map(r => r.color);

  const mkDs = (key, label, color) => ({
    label,
    data: rows.map(r => {
      if (!r.rev || r.rev === 0) return 0;
      return Math.max(0, parseFloat((r[key]/r.rev*100).toFixed(2)));
    }),
    backgroundColor: color,
    stack: 'stack',
  });

  // Loss segment
  const lossDs = {
    label: '×”×¤×¡×“',
    data: rows.map(r => {
      if (!r.rev || r.rev === 0) return 0;
      return r.cont < 0 ? parseFloat((Math.abs(r.cont)/r.rev*100).toFixed(2)) : 0;
    }),
    backgroundColor: '#dc2626',
    stack: 'stack',
  };

  const contDs = {
    label: '×ª×¨×•××” ×™×©×™×¨×”',
    data: rows.map(r => {
      if (!r.rev || r.rev === 0) return 0;
      return r.cont > 0 ? parseFloat((r.cont/r.rev*100).toFixed(2)) : 0;
    }),
    backgroundColor: '#059669',
    stack: 'stack',
  };

  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        mkDs('dr', '×©×›×¨ ×¨×•×¤××™×', '#3b6fd4'),
        mkDs('em', '×©×›×¨ ×¢×•×‘×“×™×', '#7c3aed'),
        mkDs('co', '×§×‘×œ× ×™ ××©× ×”', '#0891b2'),
        mkDs('vm', '×•×˜××¨×§×˜', '#d97706'),
        contDs,
        lossDs,
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          rtl: true,
          backgroundColor: '#152847',
          titleColor: '#fff',
          bodyColor: 'rgba(255,255,255,0.82)',
          borderColor: 'rgba(255,255,255,0.1)',
          borderWidth: 1,
          padding: 13,
          callbacks: {
            title: items => items[0].label,
            label: c => {
              if (c.raw === 0) return null;
              const row = buildData(currentGroup)[c.dataIndex];
              const absVal = c.raw / 100 * row.rev;
              return ` ${c.dataset.label}: ${c.raw.toFixed(1)}%  (${fmt(absVal)})`;
            },
            afterBody: items => {
              const row = buildData(currentGroup)[items[0].dataIndex];
              return [``, `ğŸ“Š ×”×›× ×¡×•×ª: ${fmt(row.rev)}`];
            }
          }
        }
      },
      scales: {
        x: {
          stacked: true,
          ticks: { color: '#6b7280', font: { family: 'Heebo', size: 11 }, maxRotation: 0 },
          grid: { display: false },
        },
        y: {
          stacked: true,
          min: 0, max: 115,
          ticks: {
            color: '#6b7280', font: { family: 'Heebo', size: 11 },
            callback: v => v + '%',
            stepSize: 20,
          },
          grid: { color: '#f0f4fb' },
        }
      }
    }
  });
}

function renderMiniKpis(rows) {
  const totals = rows.reduce((acc, r) => {
    acc.rev  += r.rev  || 0;
    acc.dr   += r.dr   || 0;
    acc.em   += r.em   || 0;
    acc.vm   += r.vm   || 0;
    acc.co   += r.co   || 0;
    acc.cont += r.cont || 0;
    return acc;
  }, {rev:0, dr:0, em:0, vm:0, co:0, cont:0});

  const items = [
    { lbl:'×”×›× ×¡×•×ª ×¡×”×´×›',    val:fmt(totals.rev),  pct:'',                          c:'#152847' },
    { lbl:'×©×›×¨ ×¨×•×¤××™×',     val:fmt(totals.dr),   pct:fmtPct(totals.dr,totals.rev), c:'#3b6fd4' },
    { lbl:'×©×›×¨ ×¢×•×‘×“×™×',     val:fmt(totals.em),   pct:fmtPct(totals.em,totals.rev), c:'#7c3aed' },
    { lbl:'×•×˜××¨×§×˜',         val:fmt(totals.vm),   pct:fmtPct(totals.vm,totals.rev), c:'#d97706' },
    { lbl:'×§×‘×œ× ×™ ××©× ×”',     val:fmt(totals.co),   pct:fmtPct(totals.co,totals.rev), c:'#0891b2' },
    { lbl:'×ª×¨×•××” ×™×©×™×¨×”',    val:fmt(totals.cont), pct:fmtPct(totals.cont,totals.rev),c: totals.cont>=0?'#059669':'#dc2626' },
  ];
  document.getElementById('miniKpis').innerHTML = items.map(it => `
    <div class="mk">
      <div class="mk-lbl">${it.lbl}</div>
      <div class="mk-val" style="color:${it.c}">${it.val}</div>
      ${it.pct ? `<div class="mk-pct" style="color:${it.c}">${it.pct} ××”×›× ×¡×•×ª</div>` : ''}
    </div>
  `).join('');
}

function renderTable(rows) {
  let html = '';
  rows.forEach(r => {
    const mPct = r.rev > 0 ? r.cont/r.rev*100 : 0;
    const mClass = mPct >= 40 ? 'cg' : mPct >= 10 ? 'cw' : 'cb';
    const drPct = pn(r.dr,r.rev), emPct = pn(r.em,r.rev), vmPct = pn(r.vm,r.rev), coPct = pn(r.co,r.rev);
    const prPct = Math.max(0, pn(r.cont,r.rev));

    const cpill = (val, rev, c) => val
      ? `<div style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.2rem 0.65rem;border-radius:50px;background:${c}18;color:${c};border:1px solid ${c}30;font-size:0.71rem;font-weight:700">
          ${fmt(val)}<span style="opacity:0.65">${fmtPct(val,rev)}</span>
        </div>`
      : `<span style="color:#d1d5db;font-size:0.72rem">â€”</span>`;

    html += `<tr>
      <td><div class="t-name"><span class="t-dot" style="background:${r.color}"></span>${r.name}</div></td>
      <td class="t-num" style="color:#152847;font-weight:800">${fmt(r.rev)}</td>
      <td class="tc">${cpill(r.dr, r.rev, '#3b6fd4')}</td>
      <td class="tc">${cpill(r.em, r.rev, '#7c3aed')}</td>
      <td class="tc">${cpill(r.vm, r.rev, '#d97706')}</td>
      <td class="tc">${cpill(r.co, r.rev, '#0891b2')}</td>
      <td>
        <div class="ibar-wrap">
          <div class="ibar-track">
            <div class="ibar-seg" style="width:${Math.min(drPct,100)}%;background:#3b6fd4"></div>
            <div class="ibar-seg" style="width:${Math.min(emPct,100)}%;background:#7c3aed"></div>
            <div class="ibar-seg" style="width:${Math.min(vmPct,100)}%;background:#d97706"></div>
            <div class="ibar-seg" style="width:${Math.min(coPct,100)}%;background:#0891b2"></div>
            <div class="ibar-seg" style="width:${Math.min(prPct,100)}%;background:#059669"></div>
          </div>
        </div>
      </td>
      <td class="tc">
        <div style="display:inline-flex;align-items:center;padding:0.2rem 0.65rem;border-radius:50px;background:${r.cont<0?'#fef2f2':'#ecfdf5'};color:${r.cont<0?'#991b1b':'#065f46'};border:1px solid ${r.cont<0?'#fecaca':'#a7f3d0'};font-size:0.71rem;font-weight:800">
          ${fmt(r.cont)}
        </div>
      </td>
      <td class="tc"><span class="chip ${mClass}">${mPct>=0?'+':''}${mPct.toFixed(1)}%</span></td>
    </tr>`;
  });
  document.getElementById('tbody').innerHTML = html;
}

function renderPieChart(rows) {
  if (pieChart) pieChart.destroy();
  const ctx = document.getElementById('pieChart').getContext('2d');

  // Sum all categories across visible rows
  const totals = rows.reduce((acc, r) => {
    acc.dr += r.dr || 0;
    acc.em += r.em || 0;
    acc.co += r.co || 0;
    acc.vm += r.vm || 0;
    acc.cont += Math.max(0, r.cont || 0);
    return acc;
  }, { dr:0, em:0, co:0, vm:0, cont:0 });

  const total = totals.dr + totals.em + totals.co + totals.vm + totals.cont;

  // Update subtitle
  document.getElementById('pieSub').textContent =
    `×¡×”×´×›: ${fmt(total)} â€¢ ${GROUPS[currentGroup].monthly ? '6 ×—×•×“×©×™×' : rows.length + ' ×™×—×™×“×•×ª'}`;

  pieChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['×©×›×¨ ×¨×•×¤××™×', '×©×›×¨ ×¢×•×‘×“×™×', '×§×‘×œ× ×™ ××©× ×”', '×•×˜××¨×§×˜', '×ª×¨×•××” ×™×©×™×¨×”'],
      datasets: [{
        data: [totals.dr, totals.em, totals.co, totals.vm, totals.cont],
        backgroundColor: ['#3b6fd4', '#7c3aed', '#0891b2', '#d97706', '#059669'],
        borderColor: '#fff',
        borderWidth: 3,
        hoverOffset: 8,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom', rtl: true,
          labels: {
            color: '#374151', font: { family: 'Heebo', size: 11 },
            padding: 12, usePointStyle: true, pointStyleWidth: 9,
            filter: item => item.parsed > 0,
          }
        },
        tooltip: {
          rtl: true,
          backgroundColor: '#152847',
          titleColor: '#fff',
          bodyColor: 'rgba(255,255,255,0.82)',
          borderColor: 'rgba(255,255,255,0.1)',
          borderWidth: 1,
          padding: 12,
          callbacks: {
            label: c => {
              if (c.parsed === 0) return null;
              const pct = total > 0 ? (c.parsed / total * 100).toFixed(1) : 0;
              return ` ${c.label}: ${fmt(c.parsed)}  (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function renderInsights(rows) {
  // Find best, worst, and most investment-heavy
  const valid = rows.filter(r => r.rev > 0);
  const byMargin = [...valid].sort((a,b) => b.cont/b.rev - a.cont/a.rev);
  const best = byMargin[0], worst = byMargin[byMargin.length-1];
  const byDrPct = [...valid].sort((a,b) => b.dr/b.rev - a.dr/a.rev);
  const heaviestDr = byDrPct[0];

  const bestPct = (best.cont/best.rev*100).toFixed(1);
  const worstPct = (worst.cont/worst.rev*100).toFixed(1);
  const drHeavyPct = (heaviestDr.dr/heaviestDr.rev*100).toFixed(1);

  document.getElementById('insightGrid').innerHTML = `
    <div class="insight-card ic-green">
      <div class="ic-icon">ğŸ†</div>
      <div><div class="ic-title">××¨×•×•×— ×’×‘×•×” ×‘×™×•×ª×¨ â€” ${best.name}</div>
      <div class="ic-body">×ª×¨×•××” ×™×©×™×¨×” ×©×œ <strong>${bestPct}%</strong> ××”×›× ×¡×•×ª (${fmt(best.cont)}). ×–×”×• ×”×¡× ×™×£/××—×œ×§×” ×¢× ×”-ROI ×”×˜×•×‘ ×‘×™×•×ª×¨ â€” ××•×¢××“ ×œ×”×¨×—×‘×ª ×”×©×§×¢×”.</div></div>
    </div>
    <div class="insight-card ic-red">
      <div class="ic-icon">âš ï¸</div>
      <div><div class="ic-title">××¨×•×•×— × ××•×š â€” ${worst.name}</div>
      <div class="ic-body">×ª×¨×•××” ×™×©×™×¨×” ×©×œ <strong>${worstPct}%</strong>. ${parseFloat(worstPct)<0?'×ª×¨×•××” ×©×œ×™×œ×™×ª â€” ×”×”×•×¦××•×ª ×¢×•×œ×•×ª ×¢×œ ×”×”×›× ×¡×•×ª. ×“×•×¨×© ×‘×“×™×§×” ××™×™×“×™×ª.':'××¨×•×•×— × ××•×š ×”×“×•×¨×© ×©×™×¤×•×¨ ×‘×™×¢×™×œ×•×ª ×ª×¤×¢×•×œ×™×ª.'}</div></div>
    </div>
    <div class="insight-card ic-blue">
      <div class="ic-icon">ğŸ’¡</div>
      <div><div class="ic-title">×¢×œ×•×ª ×©×›×¨ ×¨×•×¤××™× ×’×‘×•×”×” â€” ${heaviestDr.name}</div>
      <div class="ic-body">×©×›×¨ ×¨×•×¤××™× ×¢×•××“ ×¢×œ <strong>${drHeavyPct}%</strong> ××”×›× ×¡×•×ª. ×›×“××™ ×œ×‘×—×•×Ÿ ××•×“×œ ×©×›×¨ ×—×œ×•×¤×™ ××• ×”×’×“×œ×ª ×”×›× ×¡×•×ª ×‘××•×ª×• ×ª×—×•×.</div></div>
    </div>
  `;
}

renderAll();

// â”€â”€â”€ BRANCH COMPARISON â”€â”€â”€
const BRANCHES_LIST = ['×›×¤×¨ ×¡×‘×','×¨×—×•×‘×•×ª','×‘××¨ ×©×‘×¢','×—×™×¤×”','××•×¦×§×™×Ÿ'];
let compView = 'revenue';
let compChart = null;

const BRANCH_COLORS = {
  '×›×¤×¨ ×¡×‘×':'#0891b2','×¨×—×•×‘×•×ª':'#7c3aed','×‘××¨ ×©×‘×¢':'#059669','×—×™×¤×”':'#0284c7','××•×¦×§×™×Ÿ':'#d97706'
};

function setCompView(v, el) {
  compView = v;
  document.querySelectorAll('.ctab').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  renderComparison();
}

function renderComparison() {
  const branches = BRANCHES_LIST.map(k => ({ name: k, color: BRANCH_COLORS[k], ...ALL[k] }));

  const getVal = (b) => {
    if (compView === 'margin')  return b.rev > 0 ? b.cont / b.rev * 100 : 0;
    if (compView === 'revenue') return b.rev;
    if (compView === 'contrib') return b.cont;
    if (compView === 'dr')      return b.rev > 0 ? b.dr / b.rev * 100 : 0;
  };
  const isPercent = compView === 'margin' || compView === 'dr';
  const fmtVal = v => isPercent ? v.toFixed(1) + '%' : fmt(v);
  const labelMap = { margin:'××¨×•×•×—', revenue:'×”×›× ×¡×•×ª', contrib:'×ª×¨×•××” ×™×©×™×¨×”', dr:'×©×›×¨ ×¨×•×¤××™× %' };

  const vals  = branches.map(b => getVal(b));
  const maxVal = Math.max(...vals.map(Math.abs));
  const sorted = branches.map((b,i) => ({ ...b, val: vals[i] })).sort((a,b) => b.val - a.val);

  // Cards
  document.getElementById('compGrid').innerHTML = sorted.map((b, rank) => {
    const pct = maxVal > 0 ? Math.max(0, b.val / maxVal * 100) : 0;
    const col = b.val < 0 ? '#dc2626' : b.color;
    return `
      <div class="comp-card" style="--cc:${col}">
        <div class="cc-rank">${rank+1}</div>
        <div class="cc-name"><span class="cc-dot"></span>${b.name}</div>
        <div class="cc-big" style="--ccol:${col}">${fmtVal(b.val)}</div>
        <div class="cc-lbl">${labelMap[compView]}</div>
        <div class="cc-bar-wrap">
          <div class="cc-bar-track">
            <div class="cc-bar-fill" style="width:${pct}%;background:${col}"></div>
          </div>
          <div class="cc-bar-sub">×”×›× ×¡×•×ª: ${fmt(b.rev)}</div>
        </div>
      </div>`;
  }).join('');

  // Horizontal bar chart
  if (compChart) compChart.destroy();
  compChart = new Chart(document.getElementById('compChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: sorted.map(b => b.name),
      datasets: [{
        label: labelMap[compView],
        data: sorted.map(b => isPercent ? parseFloat(b.val.toFixed(2)) : b.val),
        backgroundColor: sorted.map(b => (b.val < 0 ? '#dc2626' : b.color) + 'bb'),
        borderColor:     sorted.map(b => b.val < 0 ? '#dc2626' : b.color),
        borderWidth: 2, borderRadius: 8,
        hoverBackgroundColor: sorted.map(b => b.val < 0 ? '#dc2626' : b.color),
        barThickness: 28,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          rtl: true, backgroundColor:'#152847', titleColor:'#fff',
          bodyColor:'rgba(255,255,255,0.85)', borderColor:'rgba(255,255,255,0.1)',
          borderWidth:1, padding:12,
          callbacks: {
            label: c => ` ${labelMap[compView]}: ${fmtVal(c.raw)}`,
            afterLabel: c => {
              const b = sorted[c.dataIndex];
              return [` ×”×›× ×¡×•×ª: ${fmt(b.rev)}`, ` ×ª×¨×•××” ×™×©×™×¨×”: ${fmt(b.cont)}`];
            }
          }
        }
      },
      scales: {
        x: {
          ticks:{ color:'#94a3b8', font:{family:'Heebo',size:12}, callback: v => isPercent ? v+'%' : fmt(v) },
          grid:{ color:'#f0f4fb' }
        },
        y: {
          ticks:{ color:'#1e293b', font:{family:'Heebo',size:13,weight:'700'}, padding: 8 },
          grid:{ display:false }
        }
      },
      layout: { padding: { right: 20 } }
    }
  });
}


// â”€â”€â”€ CUSTOM COMPARISON BUILDER â”€â”€â”€
const MONTHLY_DATA = {
  '×›×¤×¨ ×¡×‘×':  '×›×¤×¨ ×¡×‘×_monthly',
  '×¨×—×•×‘×•×ª':   '×¨×—×•×‘×•×ª_monthly',
  '×‘××¨ ×©×‘×¢':  '×‘××¨ ×©×‘×¢_monthly',
  '×—×™×¤×”':     '×—×™×¤×”_monthly',
  '××•×¦×§×™×Ÿ':   '××•×¦×§×™×Ÿ_monthly',
  '×—×™×¨×•×':    '×—×™×¨×•×_monthly',
  '× ×•×™×¨×•×œ×•×’×™×”':'× ×•×™×¨×•×œ×•×’×™×”_monthly',
  '×”×“××™×”':    '×”×“××™×”_monthly',
  '×›×™×¨×•×¨×’×™×”': '×›×™×¨×•×¨×’×™×”_monthly',
  '×§×¨×“×™×•×œ×•×’×™×”':'×§×¨×“×™×•×œ×•×’×™×”_monthly',
  '××•× ×§×•×œ×•×’×™×”':'××•× ×§×•×œ×•×’×™×”_monthly',
  '×”×¨×“××”':    '×”×¨×“××”_monthly',
};
const ENTITY_COLORS = {
  '×›×¤×¨ ×¡×‘×':'#0891b2','×¨×—×•×‘×•×ª':'#7c3aed','×‘××¨ ×©×‘×¢':'#059669','×—×™×¤×”':'#0284c7','××•×¦×§×™×Ÿ':'#d97706',
  '×—×™×¨×•×':'#ef4444','× ×•×™×¨×•×œ×•×’×™×”':'#ec4899','×”×“××™×”':'#14b8a6','×›×™×¨×•×¨×’×™×”':'#a855f7',
  '×§×¨×“×™×•×œ×•×’×™×”':'#f43f5e','××•× ×§×•×œ×•×’×™×”':'#f97316','×”×¨×“××”':'#84cc16',
};
const MONTHS_LABELS = ['××•×’×³ 25','×¡×¤×˜×³ 25','××•×§×³ 25','× ×•×‘×³ 25','×“×¦××³ 25','×™× ×•×³ 26'];

let csMetric = 'cont';
let csLineChart = null, csBarChart = null;

function toggleSel(el) {
  el.classList.toggle('active');
  autoRunComparison();
}

function setMetric(el) {
  document.querySelectorAll('.smb').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  csMetric = el.dataset.metric;
  autoRunComparison();
}

function autoRunComparison() {
  const months   = getSelMonths();
  const entities = getSelEntities();
  const results  = document.getElementById('csResults');
  const empty    = document.getElementById('csEmpty');
  const status   = document.getElementById('csStatus');

  // Update hint
  const hint = document.getElementById('csMonthHint');
  if (hint && months.length) hint.textContent = `${months.length} ×—×•×“×©×™× × ×‘×—×¨×•`;

  if (!entities.length) {
    results.style.display = 'none';
    if (empty) empty.style.display = 'flex';
    status.textContent = '×‘×—×¨ ×œ×¤×—×•×ª ×™×©×•×ª ××—×ª';
    status.classList.remove('cs-status-active');
    return;
  }
  if (empty) empty.style.display = 'none';
  status.textContent = `âœ“ ${entities.length} ×™×©×•×™×•×ª â€¢ ${months.length} ×—×•×“×©×™×`;
  status.classList.add('cs-status-active');
  runCustomComparison();
}

function getSelMonths() {
  return [...document.querySelectorAll('.sch[data-type="month"].active')].map(b => parseInt(b.dataset.val));
}

function selectAllMonths() {
  document.querySelectorAll('.sch[data-type="month"]').forEach(b => b.classList.add('active'));
  autoRunComparison();
}

function clearAllMonths() {
  document.querySelectorAll('.sch[data-type="month"]').forEach(b => b.classList.remove('active'));
  autoRunComparison();
}
function getSelEntities() {
  return [...document.querySelectorAll('.sch[data-type="entity"].active')].map(b => b.dataset.val);
}

function getMonthlyVal(entityName, monthIdx, metric) {
  const key = MONTHLY_DATA[entityName];
  if (!key || !ALL[key]) return 0;
  const m = ALL[key].months;
  if (metric === 'margin') {
    const r = m.rev[monthIdx];
    return r > 0 ? m.cont[monthIdx] / r * 100 : 0;
  }
  return m[metric]?.[monthIdx] ?? 0;
}

function runCustomComparison() {
  const months   = getSelMonths();
  const entities = getSelEntities();

  if (!months.length)   { alert('×‘×—×¨ ×œ×¤×—×•×ª ×—×•×“×© ××—×“'); return; }
  if (!entities.length) { alert('×‘×—×¨ ×œ×¤×—×•×ª ×™×©×•×ª ××—×ª (×¡× ×™×£ ××• ××—×œ×§×”)'); return; }

  const metricLabelMap = { cont:'×ª×¨×•××” ×™×©×™×¨×”', rev:'×”×›× ×¡×•×ª', dr:'×©×›×¨ ×¨×•×¤××™×', em:'×©×›×¨ ×¢×•×‘×“×™×', vm:'×•×˜××¨×§×˜', margin:'××¨×•×•×— %' };
  const isPercent = csMetric === 'margin';
  const mLabel = metricLabelMap[csMetric];
  const selMonthLabels = months.map(i => MONTHS_LABELS[i]);

  // Result header
  document.getElementById('csResultHead').innerHTML =
    `××¦×™×’: <strong>${mLabel}</strong> ×¢×‘×•×¨ <strong>${entities.join(', ')}</strong> ×‘×—×•×“×©×™×: <strong>${selMonthLabels.join(', ')}</strong>`;

  // â”€â”€ LINE CHART â”€â”€
  if (csLineChart) csLineChart.destroy();
  const lineDatasets = entities.map(name => ({
    label: name,
    data: months.map(mi => {
      const v = getMonthlyVal(name, mi, csMetric);
      return isPercent ? parseFloat(v.toFixed(2)) : Math.round(v);
    }),
    borderColor: ENTITY_COLORS[name] || '#888',
    backgroundColor: (ENTITY_COLORS[name] || '#888') + '22',
    borderWidth: 2.5, pointRadius: 5, pointHoverRadius: 7,
    tension: 0.35, fill: false,
  }));

  csLineChart = new Chart(document.getElementById('csLineChart').getContext('2d'), {
    type: 'line',
    data: { labels: selMonthLabels, datasets: lineDatasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position:'top', rtl:true, labels:{ color:'#374151', font:{family:'Heebo',size:11}, padding:12, usePointStyle:true } },
        tooltip: { rtl:true, backgroundColor:'#152847', titleColor:'#fff', bodyColor:'rgba(255,255,255,0.85)', borderColor:'rgba(255,255,255,0.1)', borderWidth:1, padding:10,
          callbacks: { label: c => ` ${c.dataset.label}: ${isPercent ? c.raw+'%' : fmt(c.raw)}` }
        }
      },
      scales: {
        x: { ticks:{ color:'#94a3b8', font:{family:'Heebo',size:11} }, grid:{ color:'#f0f4fb' } },
        y: { ticks:{ color:'#94a3b8', font:{family:'Heebo',size:11}, callback: v => isPercent ? v+'%' : fmt(v) }, grid:{ color:'#f0f4fb' } }
      }
    }
  });

  // â”€â”€ BAR CHART (avg over selected months) â”€â”€
  if (csBarChart) csBarChart.destroy();
  const barVals = entities.map(name => {
    const vals = months.map(mi => getMonthlyVal(name, mi, csMetric));
    const s = vals.reduce((a,b)=>a+b,0);
    return isPercent ? parseFloat((s/months.length).toFixed(2)) : Math.round(s/months.length);
  });

  csBarChart = new Chart(document.getElementById('csBarChart').getContext('2d'), {
    type: 'bar',
    data: {
      labels: entities,
      datasets: [{
        label: `×××•×¦×¢ ×—×•×“×©×™ â€” ${mLabel}`,
        data: barVals,
        backgroundColor: entities.map(n => (ENTITY_COLORS[n]||'#888') + 'bb'),
        borderColor: entities.map(n => ENTITY_COLORS[n]||'#888'),
        borderWidth: 2, borderRadius: 8,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { display:false },
        tooltip: { rtl:true, backgroundColor:'#152847', titleColor:'#fff', bodyColor:'rgba(255,255,255,0.85)', borderColor:'rgba(255,255,255,0.1)', borderWidth:1, padding:10,
          callbacks: { label: c => ` ×××•×¦×¢: ${isPercent ? c.raw+'%' : fmt(c.raw)}` }
        }
      },
      scales: {
        x: { ticks:{ color:'#374151', font:{family:'Heebo',size:11,weight:'700'} }, grid:{ display:false } },
        y: { ticks:{ color:'#94a3b8', font:{family:'Heebo',size:11}, callback: v => isPercent ? v+'%' : fmt(v) }, grid:{ color:'#f0f4fb' } }
      }
    }
  });

  // â”€â”€ TABLE â”€â”€
  // Header: entity name | month1 | month2 | ... | ×××•×¦×¢ | ×¡×”×´×›
  let thHtml = `<tr><th>×™×©×•×ª</th>${selMonthLabels.map(m=>`<th style="text-align:center">${m}</th>`).join('')}<th style="text-align:center">×××•×¦×¢</th><th style="text-align:center">×¡×”×´×›</th></tr>`;
  document.getElementById('csTableHead').innerHTML = thHtml;

  let tbHtml = '';
  entities.forEach(name => {
    const vals = months.map(mi => getMonthlyVal(name, mi, csMetric));
    const total = vals.reduce((a,b)=>a+b,0);
    const average = total / vals.length;
    const color = ENTITY_COLORS[name] || '#888';
    tbHtml += `<tr>
      <td style="font-weight:800;color:${color};display:flex;align-items:center;gap:0.4rem">
        <span style="width:8px;height:8px;border-radius:50%;background:${color};display:inline-block;flex-shrink:0"></span>${name}
      </td>
      ${vals.map(v => `<td style="text-align:center;font-variant-numeric:tabular-nums">${isPercent ? v.toFixed(1)+'%' : fmt(v)}</td>`).join('')}
      <td style="text-align:center;font-weight:700;color:#0891b2">${isPercent ? average.toFixed(1)+'%' : fmt(average)}</td>
      <td style="text-align:center;font-weight:800;color:${isPercent?'#374151':total<0?'#dc2626':'#059669'}">${isPercent ? 'â€”' : fmt(total)}</td>
    </tr>`;
  });
  document.getElementById('csTableBody').innerHTML = tbHtml;

  document.getElementById('csResults').style.display = 'block';
}

renderComparison();

// Build initial month chips from default MONTHS data
(function initMonthChips() {
  const entityOrder = Object.keys(ALL).filter(k => !k.includes('_monthly') && ALL[k].rev > 0);
  rebuildCustomComparison(entityOrder, MONTHS.slice());
})();

const UPLOAD_HASH = '9a900bc3c5f4a026fee9c4e9b83ef4f0cce2e3e5d6f60a7e5b3d3c2e2a4a5b3'; // SHA-256 of "555"

async function sha256Upload(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function openUploadGate() {
  const el = document.getElementById('uploadGate');
  el.classList.remove('modal-hidden');
  setTimeout(() => { try { document.getElementById('uploadPwInput').focus(); } catch(e){} }, 200);
}
function closeUploadGate() {
  document.getElementById('uploadGate').classList.add('modal-hidden');
  document.getElementById('uploadPwInput').value = '';
  document.getElementById('uploadPwErr').textContent = '';
}

async function checkUploadPw() {
  const input = document.getElementById('uploadPwInput');
  const err   = document.getElementById('uploadPwErr');
  const val   = input.value.trim();
  if (!val) return;
  const hash = await sha256Upload(val);
  if (hash === UPLOAD_HASH) {
    closeUploadGate();
    document.getElementById('uploadFileInput').click();
  } else {
    err.textContent = 'âŒ ×¡×™×¡××” ×©×’×•×™×”';
    input.style.borderColor = '#dc2626';
    input.value = '';
    setTimeout(() => { input.style.borderColor = '#e0e8f5'; }, 1500);
  }
}

// â”€â”€â”€ FILE HANDLING â€” SMART PARSER â”€â”€â”€
let fvAllRows = [], fvHeaders = [];

function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      window._uploadedWb = wb;
      processSheet(wb, wb.SheetNames[0], file.name);
    } catch(err) {
      alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
  event.target.value = '';
}

function processSheet(wb, sheetName, fileName) {
  const ws = wb.Sheets[sheetName];
  const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
  const parsed = parseSheetData(json);

  if (parsed && Object.keys(parsed.entities).length >= 2) {
    injectParsedData(parsed, fileName, sheetName, wb.SheetNames);
  } else {
    // Fallback: raw table view
    showRawTable(json, fileName, sheetName, wb);
  }
}

// â”€â”€â”€ SMART PARSER â€” ××•×ª×× ×œ×¤×•×¨××˜ DASHBOARD_×›×¤×¨_×¡×‘×_×•×¡× ×™×¤×™× â”€â”€â”€
function parseSheetData(json) {

  const METRIC_MAP = {
    '×”×›× ×¡×•×ª':                          'rev',
    '×©×›×¨ ×¨×•×¤××™×':                       'dr',
    '×©×›×¨ ×¢×•×‘×“×™×':                       'em',
    '×§×‘×œ× ×™ ××©× ×” - ×¡×¤×§×™×':              'co',
    '×§×‘×œ× ×™ ××©× ×” - ×¨×•×¤××™× / ×¡×¤×§×™×':     'co',
    '×§×‘×œ× ×™ ××©× ×”':                       'co',
    '×•×˜××¨×§×˜':                          'vm',
    '×ª×¨×•××” ×™×©×™×¨×”':                     'cont',
  };
  const SKIP = new Set(['%', '×¨×•×•×—×™×•×ª ×ª×¨×•××” ×™×©×™×¨×”', '×‘×“×™×§×”']);

  const MONTH_NAMES = {
    1:'×™× ×•×³',2:'×¤×‘×¨×³',3:'××¨×¦×³',4:'××¤×¨×³',5:'×××™',
    6:'×™×•× ×³',7:'×™×•×œ×³',8:'××•×’×³',9:'×¡×¤×˜×³',10:'××•×§×³',11:'× ×•×‘×³',12:'×“×¦××³'
  };

  // Detect if a row is an entity-header row:
  // col B = entity name (string), cols Câ€“H = month codes like 8.25, 9.25 ... 1.26
  function isEntityHeader(row) {
    const name = String(row[1] || '').trim();
    if (!name || METRIC_MAP[name] || SKIP.has(name)) return false;
    // Check cols 2-7 look like month codes (e.g. 8.25, 9.25, 1.26)
    const candidates = row.slice(2, 8).filter(v => v !== null && v !== undefined && v !== '');
    if (candidates.length < 3) return false;
    return candidates.every(v => {
      const n = parseFloat(v);
      if (isNaN(n)) return false;
      const month = Math.floor(n <= 12 ? n : n);
      const yr    = Math.round((n % 1) * 100);
      return month >= 1 && month <= 12 && (yr === 25 || yr === 26 || yr === 0);
    });
  }

  function monthLabel(code) {
    const n     = parseFloat(code);
    const month = Math.floor(n);
    const yr    = Math.round((n % 1) * 100);
    return `${MONTH_NAMES[month] || '?'} ${yr || ''}`.trim();
  }

  function safeNum(v) {
    if (v === null || v === undefined || v === '' || v === '#DIV/0!') return 0;
    const n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }

  // â”€â”€ First pass: discover month labels from first entity header â”€â”€
  let monthLabels = [];
  let dataColStart = 2, dataColCount = 6;

  for (const row of json) {
    if (isEntityHeader(row)) {
      const codes = row.slice(2, 9).filter(v => v !== null && v !== undefined && v !== '');
      monthLabels   = codes.map(monthLabel);
      dataColCount  = codes.length;
      break;
    }
  }
  if (!monthLabels.length) return null;

  // â”€â”€ Second pass: collect entities â”€â”€
  const entities    = {};
  const entityOrder = [];
  let   currentEnt  = null;

  for (const row of json) {
    const col2 = String(row[1] || '').trim();
    if (!col2) continue;

    if (isEntityHeader(row)) {
      currentEnt = col2;
      if (!entities[col2]) {
        entities[col2] = { rev:[], dr:[], em:[], co:[], vm:[], cont:[] };
        entityOrder.push(col2);
      }
      continue;
    }

    if (!currentEnt) continue;
    if (SKIP.has(col2)) continue;

    const metricKey = METRIC_MAP[col2];
    if (!metricKey) continue;

    // Read dataColCount values starting at col index 2
    const vals = [];
    for (let ci = dataColStart; ci < dataColStart + dataColCount; ci++) {
      vals.push(safeNum(row[ci]));
    }
    entities[currentEnt][metricKey] = vals;
  }

  // Pad missing arrays
  entityOrder.forEach(name => {
    const d = entities[name];
    ['rev','dr','em','co','vm','cont'].forEach(k => {
      if (!d[k] || d[k].length !== dataColCount)
        d[k] = new Array(dataColCount).fill(0);
    });
  });

  return { entities, entityOrder, monthLabels, dataColCount };
}

// â”€â”€â”€ INJECT PARSED DATA â†’ RE-RENDER FULL DASHBOARD â”€â”€â”€
const AUTO_COLORS = ['#0891b2','#7c3aed','#059669','#0284c7','#d97706','#ef4444','#ec4899','#14b8a6','#a855f7','#f43f5e','#f97316','#84cc16','#e11d48','#0ea5e9'];

// Preset colors for known entities
const KNOWN_COLORS = {
  '×¨×©×ª - ××¡×›×':     '#152847',
  '×›×¤×¨ ×¡×‘× ××¡×›×':   '#0891b2',
  '×›×¤×¨ ×¡×‘× ××—×¨':    '#64748b',
  '×—×™×¨×•×':           '#ef4444',
  '× ×•×™×¨×•×œ×•×’×™×”':      '#ec4899',
  '×”×“××™×”':           '#14b8a6',
  '×›×™×¨×•×¨×’×™×”':        '#a855f7',
  '×§×¨×“×™×•×œ×•×’×™×”':      '#f43f5e',
  '××•× ×§×•×œ×•×’×™×”':      '#f97316',
  '×”×¨×“××”':           '#84cc16',
  '×¨×—×•×‘×•×ª':          '#7c3aed',
  '×‘××¨ ×©×‘×¢':         '#059669',
  '×—×™×¤×”':            '#0284c7',
  '××•×¦×§×™×Ÿ':          '#d97706',
};

function injectParsedData(parsed, fileName, sheetName, sheetNames) {
  const { entities, entityOrder, monthLabels, dataColCount } = parsed;

  // Rebuild MONTHS global
  while (MONTHS.length) MONTHS.pop();
  monthLabels.forEach(m => MONTHS.push(m));

  // Clear and rebuild ALL
  Object.keys(ALL).forEach(k => delete ALL[k]);

  entityOrder.forEach((name, idx) => {
    const d = entities[name];
    const color = KNOWN_COLORS[name] || AUTO_COLORS[idx % AUTO_COLORS.length];
    const totRev  = d.rev.reduce((a,b)=>a+b,0);
    const totDr   = d.dr.reduce((a,b)=>a+b,0);
    const totEm   = d.em.reduce((a,b)=>a+b,0);
    const totCo   = d.co.reduce((a,b)=>a+b,0);
    const totVm   = d.vm.reduce((a,b)=>a+b,0);
    const totCont = d.cont.reduce((a,b)=>a+b,0);

    ALL[name] = { type: 'entity', color, rev: totRev, dr: totDr, em: totEm, co: totCo, vm: totVm, cont: totCont };
    ALL[name + '_monthly'] = { months: { rev: d.rev, dr: d.dr, em: d.em, co: d.co, vm: d.vm, cont: d.cont }};

    // Update MONTHLY_DATA lookup
    MONTHLY_DATA[name] = name + '_monthly';
    // Update ENTITY_COLORS
    ENTITY_COLORS[name] = color;
  });

  // Rebuild GROUPS
  Object.keys(GROUPS).forEach(k => delete GROUPS[k]);
  GROUPS['network'] = { title: `${sheetName} â€” ×›×œ ×”×™×©×•×™×•×ª`, keys: entityOrder };
  entityOrder.forEach((name, idx) => {
    GROUPS['e' + idx] = { title: `${name} â€” ×œ×¤×™ ×—×•×“×©`, monthly: name };
  });

  // Rebuild BRANCHES_LIST for comparison
  while (BRANCHES_LIST.length) BRANCHES_LIST.pop();
  entityOrder.forEach(n => {
    BRANCHES_LIST.push(n);
    BRANCH_COLORS[n] = ENTITY_COLORS[n];
  });

  // Rebuild filter buttons
  rebuildFilterButtons(entityOrder);

  // Update nav period pill
  if (monthLabels.length >= 2) {
    document.querySelector('.nav-pill').textContent = `ğŸ“… ${monthLabels[0]} â€” ${monthLabels[monthLabels.length-1]}`;
  }

  showToast(`âœ… "${fileName}" × ×˜×¢×Ÿ ×‘×”×¦×œ×—×” â€” ${entityOrder.length} ×™×©×•×™×•×ª â€¢ ${monthLabels.length} ×—×•×“×©×™×`);

  currentGroup = 'network';
  renderAll();
  renderComparison();

  // Reset custom comparison
  document.querySelectorAll('.sch').forEach(b => b.classList.remove('active'));
  document.getElementById('csResults').style.display = 'none';
  document.getElementById('csEmpty').style.display = 'flex';
  document.getElementById('csStatus').textContent = '×‘×—×¨ ×—×•×“×©×™× ×•×™×©×•×™×•×ª ×›×“×™ ×œ×”×ª×—×™×œ';
  document.getElementById('csStatus').classList.remove('cs-status-active');
  rebuildCustomComparison(entityOrder, monthLabels);
}

function rebuildFilterButtons(entityOrder) {
  const filterRow = document.querySelector('.filter-row');
  filterRow.innerHTML = `
    <button class="fb active" onclick="setGroup('network', this)">ğŸŒ ×›×œ ×”×™×©×•×™×•×ª</button>
    <div class="gr-label">×™×©×•×™×•×ª</div>
    ${entityOrder.map((name, idx) =>
      `<button class="fb" onclick="setGroup('e${idx}', this)">${name}</button>`
    ).join('')}
  `;
}

function rebuildCustomComparison(entityOrder, monthLabels) {
  // Build month chips grouped by year
  const wrap = document.getElementById('monthChipsWrap');
  if (wrap) {
    const byYear = {};
    monthLabels.forEach((label, i) => {
      const parts = label.trim().split(' ');
      const yr = parts.length > 1 ? '20' + parts[parts.length - 1] : '?';
      if (!byYear[yr]) byYear[yr] = [];
      byYear[yr].push({ label, i });
    });
    wrap.innerHTML = Object.entries(byYear).map(([yr, months]) => `
      <div>
        <div style="font-size:0.62rem;font-weight:800;letter-spacing:1px;color:var(--text4);margin-bottom:0.3rem">${yr}</div>
        <div style="display:flex;flex-wrap:wrap;gap:0.35rem">
          ${months.map(m => `<button class="sch" data-type="month" data-val="${m.i}" onclick="toggleSel(this)">${m.label.split(' ')[0]}</button>`).join('')}
        </div>
      </div>`).join('');
  }

  // Rebuild entity chips â€” split into two groups
  const half = Math.ceil(entityOrder.length / 2);
  document.getElementById('branchChips').innerHTML = entityOrder.slice(0, half).map(name =>
    `<button class="sch" data-type="entity" data-val="${name}" onclick="toggleSel(this)">${name}</button>`
  ).join('');
  document.getElementById('deptChips').innerHTML = entityOrder.slice(half).map(name =>
    `<button class="sch" data-type="entity" data-val="${name}" onclick="toggleSel(this)">${name}</button>`
  ).join('');

  document.querySelector('#branchChips').closest('.cs-col').querySelector('.cs-col-title').textContent = 'ğŸ¥ ×™×©×•×™×•×ª (1)';
  document.querySelector('#deptChips').closest('.cs-col').querySelector('.cs-col-title').textContent = 'ğŸ”¬ ×™×©×•×™×•×ª (2)';
  entityOrder.forEach(name => { MONTHLY_DATA[name] = name + '_monthly'; });
}

function showToast(msg) {
  let t = document.getElementById('dashToast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'dashToast';
    t.style.cssText = 'position:fixed;bottom:2rem;right:50%;transform:translateX(50%);background:#152847;color:#fff;padding:.75rem 1.5rem;border-radius:50px;font-family:Heebo,sans-serif;font-size:.84rem;font-weight:700;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:9998;transition:opacity .4s';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.style.opacity = '0'; }, 4000);
}

// Fallback raw table
function showRawTable(json, fileName, sheetName, wb) {
  let headerRowIdx = 0;
  for (let i = 0; i < Math.min(json.length, 10); i++) {
    if (json[i].some(c => c !== '')) { headerRowIdx = i; break; }
  }
  fvHeaders = json[headerRowIdx].map((h, i) => h !== '' ? String(h) : `×¢××•×“×” ${i+1}`);
  fvAllRows = json.slice(headerRowIdx + 1).filter(r => r.some(c => c !== ''));

  const tabs = wb.SheetNames.map((name, i) =>
    `<button onclick="loadSheet(event,'${name.replace(/'/g,"\\'")}',this)"
      style="padding:.35rem .9rem;border-radius:50px;border:1.5px solid ${i===0?'#152847':'#e0e8f5'};background:${i===0?'#152847':'#fff'};color:${i===0?'#fff':'#374151'};font-family:'Heebo',sans-serif;font-size:.75rem;font-weight:700;cursor:pointer">
      ${name}</button>`
  ).join('');
  document.getElementById('fvSheetTabs').innerHTML = tabs;
  document.getElementById('fvTitle').textContent = `ğŸ“„ ${fileName} â€” ${sheetName}`;
  document.getElementById('fvMeta').textContent = `${fvAllRows.length} ×©×•×¨×•×ª â€¢ ${fvHeaders.length} ×¢××•×“×•×ª`;
  renderFvTable(fvHeaders, fvAllRows);
  document.getElementById('fileViewer').classList.remove('modal-hidden');
}

function loadSheet(e, sheetName, btn) {
  const wb = window._uploadedWb;
  if (!wb) return;
  const ws = wb.Sheets[sheetName];
  const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
  let headerRowIdx = 0;
  for (let i = 0; i < Math.min(json.length, 10); i++) {
    if (json[i].some(c => c !== '')) { headerRowIdx = i; break; }
  }
  fvHeaders = json[headerRowIdx].map((h, i) => h !== '' ? String(h) : `×¢××•×“×” ${i+1}`);
  fvAllRows = json.slice(headerRowIdx + 1).filter(r => r.some(c => c !== ''));
  document.getElementById('fvMeta').textContent = `${fvAllRows.length} ×©×•×¨×•×ª â€¢ ${fvHeaders.length} ×¢××•×“×•×ª â€¢ ×’×œ×™×•×Ÿ: ${sheetName}`;
  document.querySelectorAll('#fvSheetTabs button').forEach(b => { b.style.background='#fff'; b.style.color='#374151'; b.style.borderColor='#e0e8f5'; });
  btn.style.background='#152847'; btn.style.color='#fff'; btn.style.borderColor='#152847';
  document.getElementById('fvSearch').value = '';
  renderFvTable(fvHeaders, fvAllRows);
}

function renderFvTable(headers, rows) {
  document.getElementById('fvCount').textContent = `××¦×™×’ ${rows.length} ×©×•×¨×•×ª`;
  const isNum = v => v !== '' && !isNaN(Number(v));
  const fmtCell = v => {
    if (v===''||v===null||v===undefined) return '<span style="color:#d1d5db">â€”</span>';
    if (isNum(v)) { const n=Number(v); if(Math.abs(n)>=1000) return `<span style="color:#152847;font-weight:600">${n.toLocaleString('he-IL')}</span>`; if(n<0) return `<span style="color:#dc2626">${n.toLocaleString('he-IL')}</span>`; }
    return String(v);
  };
  const thead = `<thead><tr style="background:#152847;position:sticky;top:0">
    <th style="padding:.7rem .9rem;font-size:.65rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,.6);text-align:right">#</th>
    ${headers.map(h=>`<th style="padding:.7rem .9rem;font-size:.65rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,.7);text-align:right;white-space:nowrap">${h}</th>`).join('')}
  </tr></thead>`;
  const tbody = `<tbody>${rows.map((row,ri)=>`
    <tr style="border-bottom:1px solid #f1f5f9;background:${ri%2===0?'#fff':'#fafbff'}" onmouseover="this.style.background='#eff6ff'" onmouseout="this.style.background='${ri%2===0?'#fff':'#fafbff'}'">
      <td style="padding:.65rem .9rem;font-size:.72rem;color:#94a3b8;text-align:right">${ri+1}</td>
      ${headers.map((_,ci)=>`<td style="padding:.65rem .9rem;font-size:.81rem;text-align:right;white-space:nowrap">${fmtCell(row[ci])}</td>`).join('')}
    </tr>`).join('')}</tbody>`;
  document.getElementById('fvTable').innerHTML = thead + tbody;
}

function filterFvTable() {
  const q = document.getElementById('fvSearch').value.toLowerCase();
  if (!q) { renderFvTable(fvHeaders, fvAllRows); return; }
  const filtered = fvAllRows.filter(row => row.some(c => String(c).toLowerCase().includes(q)));
  document.getElementById('fvCount').textContent = `××¦×™×’ ${filtered.length} ××ª×•×š ${fvAllRows.length} ×©×•×¨×•×ª`;
  const tbody = `<tbody>${filtered.map((row,ri)=>`
    <tr style="border-bottom:1px solid #f1f5f9;background:${ri%2===0?'#fff':'#fafbff'}" onmouseover="this.style.background='#eff6ff'" onmouseout="this.style.background='${ri%2===0?'#fff':'#fafbff'}'">
      <td style="padding:.65rem .9rem;font-size:.72rem;color:#94a3b8">${ri+1}</td>
      ${fvHeaders.map((_,ci)=>{const v=row[ci];const s=String(v||'');const idx=s.toLowerCase().indexOf(q);return`<td style="padding:.65rem .9rem;font-size:.81rem;text-align:right;white-space:nowrap">${idx>=0?s.slice(0,idx)+`<mark style="background:#fef08a;border-radius:2px">${s.slice(idx,idx+q.length)}</mark>`+s.slice(idx+q.length):s}</td>`;}).join('')}
    </tr>`).join('')}</tbody>`;
  const table = document.getElementById('fvTable');
  table.querySelector('tbody')?.remove();
  table.insertAdjacentHTML('beforeend', tbody);
}

function closeFileViewer() { document.getElementById('fileViewer').classList.add('modal-hidden'); }

// Compute correct hash on load and patch
(async () => {
  const h = await sha256Upload('555');
  window._uploadHash = h;
  // Patch checkUploadPw to use live hash
  const orig = checkUploadPw;
  window.checkUploadPw = async function() {
    const input = document.getElementById('uploadPwInput');
    const err   = document.getElementById('uploadPwErr');
    const val   = input.value.trim();
    if (!val) return;
    const hash = await sha256Upload(val);
    if (hash === window._uploadHash) {
      closeUploadGate();
      document.getElementById('uploadFileInput').click();
    } else {
      err.textContent = 'âŒ ×¡×™×¡××” ×©×’×•×™×”';
      input.style.borderColor = '#dc2626';
      input.value = '';
      setTimeout(() => { input.style.borderColor = '#e0e8f5'; }, 1500);
    }
  };
})();

// â”€â”€â”€ CEO COMMAND CENTER â”€â”€â”€
function refreshCEO() { renderCEO(); }

function renderCEO() {
  const grid = document.getElementById('ceoGrid');
  if (!grid) return;
  const all = Object.keys(ALL).filter(k => !k.includes('_monthly') && ALL[k].rev > 0);
  if (!all.length) return;

  // Card 1: Traffic Light
  const trafficRows = all.map(name => {
    const d = ALL[name]; const pct = d.cont/d.rev*100;
    const cls = pct>=40?'tl-green':pct>=15?'tl-yellow':'tl-red';
    const col = pct>=40?'#059669':pct>=15?'#d97706':'#dc2626';
    return `<div class="traffic-row">
      <div style="display:flex;align-items:center;gap:0.5rem"><div class="traffic-light ${cls}"></div><span class="traffic-name">${name}</span></div>
      <span class="traffic-pct" style="color:${col}">${pct.toFixed(1)}%</span>
    </div>`;
  }).join('');

  // Card 2: MoM
  const lastMonth = MONTHS[MONTHS.length-1]||'', prevMonth = MONTHS[MONTHS.length-2]||'';
  const momRows = all.map(name => {
    const mk=MONTHLY_DATA[name]; if(!mk||!ALL[mk]) return null;
    const m=ALL[mk].months; const n=m.rev.length; if(n<2) return null;
    const p1=m.rev[n-2]>0?m.cont[n-2]/m.rev[n-2]*100:0;
    const p2=m.rev[n-1]>0?m.cont[n-1]/m.rev[n-1]*100:0;
    const d=p2-p1; const arrow=d>0.5?'â–²':d<-0.5?'â–¼':'â†’';
    const cls=d>0.5?'mom-up':d<-0.5?'mom-down':'mom-flat';
    return `<div class="mom-row"><span class="mom-name">${name}</span>
      <span class="mom-delta ${cls}">${arrow} ${Math.abs(d).toFixed(1)}% <span style="font-size:.65rem;opacity:.6">(${p2.toFixed(1)}%)</span></span></div>`;
  }).filter(Boolean).join('');

  // Card 3: Alerts
  const alerts = [];
  const best = all.reduce((a,b)=>ALL[b].cont/ALL[b].rev>ALL[a].cont/ALL[a].rev?b:a);
  alerts.push({icon:'ğŸ†',text:`<strong>${best}</strong> â€” ×‘×™×¦×•×¢ ××™×˜×‘×™: ${(ALL[best].cont/ALL[best].rev*100).toFixed(1)}% ××¨×•×•×—`});
  all.forEach(name=>{
    const d=ALL[name]; const pct=d.cont/d.rev*100; const drP=d.dr/d.rev*100;
    if(d.cont<0) alerts.push({icon:'ğŸš¨',text:`<strong>${name}</strong> â€” ×ª×¨×•××” ×©×œ×™×œ×™×ª (${fmt(d.cont)})`});
    else if(pct<10) alerts.push({icon:'âš ï¸',text:`<strong>${name}</strong> â€” ××¨×•×•×— ${pct.toFixed(1)}% â€” × ××•×š`});
    if(drP>60) alerts.push({icon:'ğŸ’°',text:`<strong>${name}</strong> â€” ×©×›×¨ ×¨×•×¤××™× ${drP.toFixed(0)}% â€” ×’×‘×•×”`});
    const mk=MONTHLY_DATA[name];
    if(mk&&ALL[mk]){const m=ALL[mk].months;const n=m.rev.length;if(n>=2){
      const p1=m.rev[n-2]>0?m.cont[n-2]/m.rev[n-2]*100:0, p2=m.rev[n-1]>0?m.cont[n-1]/m.rev[n-1]*100:0;
      if(p1-p2>10) alerts.push({icon:'ğŸ“‰',text:`<strong>${name}</strong> â€” ×™×¨×™×“×” ${(p1-p2).toFixed(1)}% ××”×—×•×“×© ×”×§×•×“×`});
    }}
  });
  const alertsHtml = alerts.slice(0,7).map(a=>`<div class="alert-item"><span class="alert-icon">${a.icon}</span><span class="alert-text">${a.text}</span></div>`).join('');

  // Card 4: KPIs
  const totRev=all.reduce((s,k)=>s+ALL[k].rev,0), totCont=all.reduce((s,k)=>s+ALL[k].cont,0);
  const totDr=all.reduce((s,k)=>s+ALL[k].dr,0), avgM=totRev>0?totCont/totRev*100:0;
  const kpiHtml=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.8rem">${[
    {label:'×”×›× ×¡×•×ª ×¨×©×ª',val:fmt(totRev),color:'#0891b2'},
    {label:'×ª×¨×•××” ×™×©×™×¨×”',val:fmt(totCont),color:totCont<0?'#dc2626':'#059669'},
    {label:'××¨×•×•×— ×××•×¦×¢',val:avgM.toFixed(1)+'%',color:avgM<20?'#dc2626':avgM<35?'#d97706':'#059669'},
    {label:'×©×›×¨ ×¨×•×¤××™×',val:fmt(totDr),color:'#7c3aed'},
  ].map(k=>`<div style="background:var(--bg);border-radius:10px;padding:0.8rem;border:1px solid var(--border)">
    <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text4);margin-bottom:.3rem">${k.label}</div>
    <div style="font-size:1.1rem;font-weight:900;color:${k.color};letter-spacing:-.5px">${k.val}</div>
  </div>`).join('')}</div>`;

  // Card 5: Revenue rank
  const rankData=all.map(k=>({name:k,rev:ALL[k].rev,pct:ALL[k].cont/ALL[k].rev*100})).sort((a,b)=>b.rev-a.rev);
  const maxR=rankData[0]?.rev||1;
  const rankHtml=rankData.map((r,i)=>{
    const w=(r.rev/maxR*100).toFixed(1);
    const c=r.pct<0?'#ef4444':r.pct<20?'#f59e0b':r.pct<40?'#0891b2':'#059669';
    return `<div style="margin-bottom:.5rem">
      <div style="display:flex;justify-content:space-between;margin-bottom:.15rem">
        <span style="font-size:.78rem;font-weight:700">${i+1}. ${r.name}</span>
        <span style="font-size:.72rem;font-weight:800;color:${c}">${r.pct.toFixed(1)}%</span>
      </div>
      <div style="height:5px;border-radius:3px;background:#e8eef5"><div style="width:${w}%;height:100%;border-radius:3px;background:${c}"></div></div>
      <div style="font-size:.65rem;color:var(--text4);margin-top:.1rem">${fmt(r.rev)}</div>
    </div>`;
  }).join('');

  // Card 6: Trend sparkline
  const sparkHtml=`<div style="position:relative;height:185px"><canvas id="ceoBranchTrend"></canvas></div>`;

  grid.innerHTML=`
    <div class="ceo-card"><div class="ceo-card-title">ğŸš¦ ××¦×‘ ××¨×•×•×—×™×</div>${trafficRows}</div>
    <div class="ceo-card"><div class="ceo-card-title">ğŸ“ˆ ×©×™× ×•×™ ×—×•×“×©×™ (${prevMonth} â†’ ${lastMonth})</div>${momRows}</div>
    <div class="ceo-card"><div class="ceo-card-title">ğŸ”” ×”×ª×¨××•×ª</div>${alertsHtml}</div>
    <div class="ceo-card"><div class="ceo-card-title">ğŸ“Š KPI ×¨×©×ª</div>${kpiHtml}</div>
    <div class="ceo-card"><div class="ceo-card-title">ğŸ… ×“×™×¨×•×’ ×”×›× ×¡×•×ª</div>${rankHtml}</div>
    <div class="ceo-card"><div class="ceo-card-title">ğŸ“‰ ×˜×¨× ×“ ××¨×•×•×— ×œ××•×¨×š ×–××Ÿ</div>${sparkHtml}</div>
  `;

  setTimeout(()=>{
    const ctx=document.getElementById('ceoBranchTrend'); if(!ctx) return;
    const sparkEnts=all.slice(0,6);
    const ds=sparkEnts.map(name=>{
      const mk=MONTHLY_DATA[name]; if(!mk||!ALL[mk]) return null;
      const m=ALL[mk].months;
      return {label:name,data:m.rev.map((r,i)=>r>0?parseFloat((m.cont[i]/r*100).toFixed(1)):0),
        borderColor:ENTITY_COLORS[name]||'#888',borderWidth:2,pointRadius:2.5,tension:0.4,fill:false};
    }).filter(Boolean);
    new Chart(ctx.getContext('2d'),{type:'line',data:{labels:MONTHS,datasets:ds},options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'bottom',rtl:true,labels:{font:{family:'Heebo',size:10},padding:6,usePointStyle:true}}},
      scales:{x:{ticks:{color:'#94a3b8',font:{family:'Heebo',size:10}}},
              y:{ticks:{color:'#94a3b8',font:{family:'Heebo',size:10},callback:v=>v+'%'},grid:{color:'#f0f4fb'}}}
    }});
  },80);
}

setTimeout(renderCEO, 400);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ DATA ADAPTER â”€â”€ thin layer separating data from UI
// In future: replace getEntityList / getMonthlyData with API calls
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DataAdapter = (() => {
  function entities() {
    return Object.keys(ALL)
      .filter(k => !k.includes('_monthly') && (ALL[k].rev > 0 || ALL[k].cont !== undefined));
  }
  function summary(name) { return ALL[name] || null; }
  function monthly(name) {
    const key = MONTHLY_DATA[name] || name + '_monthly';
    return ALL[key]?.months || null;
  }
  function netAvg(metric) {
    // Average of a metric (as % of rev) across all entities with rev>0
    const ents = entities().filter(n => ALL[n].rev > 0);
    if (!ents.length) return 0;
    const total = ents.reduce((s,n) => s + (ALL[n][metric]||0), 0);
    const totRev = ents.reduce((s,n) => s + ALL[n].rev, 0);
    return totRev > 0 ? total / totRev * 100 : 0;
  }
  function netTotals() {
    const ents = entities().filter(n => ALL[n].rev > 0);
    return ['rev','cont','dr','em','co','vm'].reduce((acc,k) => {
      acc[k] = ents.reduce((s,n) => s + (ALL[n][k]||0), 0);
      return acc;
    }, {});
  }
  // Mom: month-over-month margin change (last 2 months)
  function mom(name) {
    const m = monthly(name); if (!m || m.rev.length < 2) return null;
    const n = m.rev.length;
    const p = m.rev[n-2] > 0 ? m.cont[n-2] / m.rev[n-2] * 100 : 0;
    const c = m.rev[n-1] > 0 ? m.cont[n-1] / m.rev[n-1] * 100 : 0;
    return { prev: p, curr: c, delta: c - p,
             revPrev: m.rev[n-2], revCurr: m.rev[n-1],
             contPrev: m.cont[n-2], contCurr: m.cont[n-1] };
  }
  // Z-score of margin over 6 months
  function zScore(name) {
    const m = monthly(name); if (!m) return null;
    const margins = m.rev.map((r,i) => r > 0 ? m.cont[i]/r*100 : null).filter(v=>v!==null);
    if (margins.length < 3) return null;
    const mu = margins.reduce((a,b)=>a+b,0)/margins.length;
    const sigma = Math.sqrt(margins.reduce((a,b)=>a+(b-mu)**2,0)/margins.length);
    const last = margins[margins.length-1];
    return { z: sigma > 0 ? (last-mu)/sigma : 0, mu, sigma, last };
  }
  return { entities, summary, monthly, netAvg, netTotals, mom, zScore };
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ DECISION HEADER â€” 3 Actionable Insight Cards
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDecisionHeader() {
  const el = document.getElementById('insightCards'); if (!el) return;
  const ents = DataAdapter.entities().filter(n => DataAdapter.summary(n)?.rev > 0);
  if (!ents.length) return;

  // Update subtitle
  const totRev = DataAdapter.netTotals().rev;
  document.getElementById('dhSub').textContent =
    `${MONTHS[0]} â€“ ${MONTHS[MONTHS.length-1]} â€¢ ×”×›× ×¡×•×ª ×¨×©×ª: ${fmt(totRev)} â€¢ ${ents.length} ×™×©×•×™×•×ª`;
  document.getElementById('dhTitle').textContent = '×××¦××™× ××¨×›×–×™×™× ×œ×ª×©×•××ª ×œ×‘';

  const cards = [];

  // â”€â”€ Card A: Best performer â†’ "Expand" â”€â”€
  const ranked = ents.map(n => {
    const d = DataAdapter.summary(n);
    return { name: n, margin: d.rev > 0 ? d.cont/d.rev*100 : 0, rev: d.rev, cont: d.cont };
  }).sort((a,b) => b.margin - a.margin);
  const best = ranked[0];
  const bestColor = '#22c55e';
  const bestDrivers = _getDrivers(best.name, 'best');
  cards.push({
    color: bestColor, badge: 'âœ… ×”×–×“×× ×•×ª', icon: 'ğŸš€',
    who: best.name,
    what: `××¨×•×•×— ××•×‘×™×œ: ${best.margin.toFixed(1)}% â€” ×‘×™×¦×•×¢×™× ×’×‘×•×”×™× ××××•×¦×¢ ×”×¨×©×ª ×‘-${(best.margin - DataAdapter.netAvg('cont')).toFixed(1)} × ×§×•×“×•×ª`,
    drivers: bestDrivers,
    cta: '×”×¨×—×‘ ×”×©×§×¢×”',
    ctaFn: `openDrilldown('${best.name.replace(/'/g,"\\'")}')`,
  });

  // â”€â”€ Card B: Biggest risk (negative margin or sharpest drop) â”€â”€
  const risks = ents.map(n => {
    const d = DataAdapter.summary(n);
    const m = DataAdapter.mom(n);
    const margin = d.rev > 0 ? d.cont/d.rev*100 : 0;
    const drop = m ? m.delta : 0;
    const score = (margin < 0 ? 50 : margin < 15 ? 20 : 0) + (drop < -8 ? 20 : 0);
    return { name: n, margin, drop, score };
  }).sort((a,b) => b.score - a.score);
  const risk = risks[0];
  const riskColor = risk.margin < 0 ? '#ef4444' : risk.margin < 15 ? '#f59e0b' : '#0891b2';
  const riskBadge = risk.margin < 0 ? 'ğŸš¨ ×§×¨×™×˜×™' : risk.margin < 15 ? 'âš ï¸ ××¢×§×‘' : 'ğŸ“Š ××¢×§×‘';
  cards.push({
    color: riskColor, badge: riskBadge, icon: risk.margin < 0 ? 'ğŸš¨' : 'âš ï¸',
    who: risk.name,
    what: `××¨×•×•×— ${risk.margin.toFixed(1)}%${risk.drop < -3 ? ` â€¢ ×™×¨×™×“×” ×©×œ ${Math.abs(risk.drop).toFixed(1)}pp ×‘×—×•×“×© ×”××—×¨×•×Ÿ` : ''}`,
    drivers: _getDrivers(risk.name, 'risk'),
    cta: '×¤×ª×— ×ª×—×§×™×¨',
    ctaFn: `openDrilldown('${risk.name.replace(/'/g,"\\'")}')`,
  });

  // â”€â”€ Card C: Biggest MoM recovery or growth opportunity â”€â”€
  const momWinners = ents.map(n => ({
    name: n, m: DataAdapter.mom(n)
  })).filter(x => x.m && x.m.delta > 2).sort((a,b) => b.m.delta - a.m.delta);
  const opp = momWinners[0] || { name: ranked[1]?.name || ents[1] || ents[0], m: DataAdapter.mom(ranked[1]?.name || ents[0]) };
  const oppM = DataAdapter.mom(opp.name);
  cards.push({
    color: '#0891b2', badge: 'ğŸ“ˆ ××’××”', icon: 'ğŸ“ˆ',
    who: opp.name,
    what: oppM && oppM.delta > 0
      ? `×©×™×¤×•×¨ ×—×•×“×©×™: +${oppM.delta.toFixed(1)}pp ×‘××¨×•×•×— (${MONTHS[MONTHS.length-2]}â†’${MONTHS[MONTHS.length-1]})`
      : `××¨×•×•×— ×™×¦×™×‘: ${((DataAdapter.summary(opp.name)?.cont||0)/(DataAdapter.summary(opp.name)?.rev||1)*100).toFixed(1)}%`,
    drivers: _getDrivers(opp.name, 'opp'),
    cta: '×‘×“×•×§ ××•×“×œ ×ª×’××•×œ',
    ctaFn: `openDrilldown('${opp.name.replace(/'/g,"\\'")}')`,
  });

  el.innerHTML = cards.map(c => `
    <div class="ic" style="--ic-color:${c.color}" onclick="${c.ctaFn}" role="button" tabindex="0" aria-label="×ª×•×‘× ×”: ${c.who}">
      <div class="ic-badge">${c.badge}</div>
      <div class="ic-who">${c.icon} ${c.who}</div>
      <div class="ic-what">${c.what}</div>
      <div class="ic-drivers"><strong>×’×•×¨××™× ××¨×›×–×™×™×:</strong><br>${c.drivers}</div>
      <button class="ic-cta" onclick="event.stopPropagation();${c.ctaFn}">${c.cta} â†’</button>
    </div>`).join('');
}

function _getDrivers(name, mode) {
  const d = DataAdapter.summary(name); if (!d || !d.rev) return 'â€”';
  const drPct = d.rev > 0 ? d.dr/d.rev*100 : 0;
  const emPct = d.rev > 0 ? d.em/d.rev*100 : 0;
  const vmPct = d.rev > 0 ? d.vm/d.rev*100 : 0;
  const netDr = DataAdapter.netAvg('dr');
  const parts = [];
  if (drPct > netDr + 5) parts.push(`×©×›×¨ ×¨×•×¤××™× ${drPct.toFixed(0)}% (×××•×¦×¢ ×¨×©×ª ${netDr.toFixed(0)}%)`);
  if (vmPct > 8) parts.push(`×•×˜××¨×§×˜ ${vmPct.toFixed(1)}% ××”×›× ×¡×•×ª`);
  if (emPct > 30) parts.push(`×©×›×¨ ×¢×•×‘×“×™× ${emPct.toFixed(1)}%`);
  const m = DataAdapter.mom(name);
  if (m && Math.abs(m.revCurr - m.revPrev) > 50000)
    parts.push(`×©×™× ×•×™ ×”×›× ×¡×•×ª ${fmt(m.revCurr - m.revPrev)}`);
  return parts.length ? parts.join(' â€¢ ') : `××¨×•×•×— ${(d.rev>0?d.cont/d.rev*100:0).toFixed(1)}%`;
}

setTimeout(renderDecisionHeader, 350);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lbSortKey = 'rev', lbSortDir = -1, lbFilterType = 'all';
let ddTrendChart = null;

function setLbFilter(type, btn) {
  lbFilterType = type;
  document.querySelectorAll('.lb-ftab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderLeaderboard();
}

function lbSort(key) {
  if (lbSortKey === key) lbSortDir *= -1;
  else { lbSortKey = key; lbSortDir = -1; }
  document.querySelectorAll('.lb-table th').forEach(th => th.classList.remove('sorted'));
  const thMap = { name:0, rev:1, margin:2, cont:3, drPct:4, mom:5, status:7 };
  const idx = thMap[key];
  if (idx !== undefined) {
    const ths = document.querySelectorAll('.lb-table th');
    if (ths[idx]) ths[idx].classList.add('sorted');
    ths[idx].querySelector('.sort-icon').textContent = lbSortDir > 0 ? 'â†‘' : 'â†“';
  }
  renderLeaderboard();
}

function renderLeaderboard() {
  const tbody = document.getElementById('lbBody'); if (!tbody) return;
  const q = (document.getElementById('lbSearch')?.value || '').trim().toLowerCase();
  const ents = DataAdapter.entities().filter(n => {
    const d = DataAdapter.summary(n); if (!d) return false;
    if (lbFilterType === 'branch' && d.type !== 'branch') return false;
    if (lbFilterType === 'dept'   && d.type !== 'dept')   return false;
    if (q && !n.toLowerCase().includes(q)) return false;
    return true;
  });

  const rows = ents.map(name => {
    const d = DataAdapter.summary(name);
    const margin = d.rev > 0 ? d.cont/d.rev*100 : 0;
    const drPct  = d.rev > 0 ? d.dr/d.rev*100 : 0;
    const m = DataAdapter.mom(name);
    const momVal = m ? m.delta : null;
    const status = margin < 0 ? 'critical' : margin < 15 ? 'watch' : 'good';
    return { name, d, margin, drPct, momVal, status };
  });

  rows.sort((a,b) => {
    let va, vb;
    switch (lbSortKey) {
      case 'name':   va = a.name; vb = b.name; return lbSortDir * va.localeCompare(vb, 'he'); break;
      case 'rev':    va = a.d.rev;    vb = b.d.rev;    break;
      case 'margin': va = a.margin;   vb = b.margin;   break;
      case 'cont':   va = a.d.cont;   vb = b.d.cont;   break;
      case 'drPct':  va = a.drPct;    vb = b.drPct;    break;
      case 'mom':    va = a.momVal??-999; vb = b.momVal??-999; break;
      case 'status': va = {good:0,watch:1,critical:2}[a.status]; vb = {good:0,watch:1,critical:2}[b.status]; break;
      default: va = 0; vb = 0;
    }
    return lbSortDir * ((va||0) - (vb||0));
  });

  const statusLabel = { good:'âœ… ×˜×•×‘', watch:'âš ï¸ ××¢×§×‘', critical:'ğŸš¨ ×§×¨×™×˜×™' };
  const statusClass = { good:'good', watch:'watch', critical:'critical' };

  tbody.innerHTML = rows.map(r => {
    const spark = _sparkline(r.name);
    const momChip = r.momVal == null ? '<span style="color:#94a3b8">â€”</span>'
      : `<span class="mom-chip ${r.momVal>0.5?'up':r.momVal<-0.5?'down':'flat'}">${r.momVal>0?'+':''}${r.momVal.toFixed(1)}pp</span>`;
    const drColor = r.drPct > 50 ? '#dc2626' : r.drPct > 35 ? '#d97706' : '#374151';
    return `<tr onclick="openDrilldown('${r.name.replace(/'/g,"\\'")}')">
      <td><div class="lb-entity-name">
        <div class="lb-dot" style="background:${r.d.color||'#888'}"></div>${r.name}
      </div></td>
      <td style="font-weight:700;color:#152847">${fmt(r.d.rev)}</td>
      <td><span style="font-weight:800;color:${r.margin<0?'#dc2626':r.margin<15?'#d97706':'#059669'}">${r.margin.toFixed(1)}%</span></td>
      <td style="font-weight:700;color:${r.d.cont<0?'#dc2626':'#374151'}">${fmt(r.d.cont)}</td>
      <td style="font-weight:700;color:${drColor}">${r.drPct.toFixed(1)}%</td>
      <td>${momChip}</td>
      <td><svg width="70" height="28">${spark}</svg></td>
      <td><span class="lb-badge ${statusClass[r.status]}">${statusLabel[r.status]}</span></td>
    </tr>`;
  }).join('') || `<tr><td colspan="8" style="text-align:center;padding:2rem;color:#94a3b8">××™×Ÿ × ×ª×•× ×™×</td></tr>`;
}

function _sparkline(name) {
  const m = DataAdapter.monthly(name); if (!m) return '';
  const vals = m.rev.map((r,i) => r > 0 ? m.cont[i]/r*100 : 0);
  const mn = Math.min(...vals), mx = Math.max(...vals);
  const range = mx - mn || 1;
  const pts = vals.map((v,i) => {
    const x = 2 + i * (66/(vals.length-1||1));
    const y = 26 - ((v-mn)/range)*22;
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  const lastUp = vals.length > 1 && vals[vals.length-1] > vals[vals.length-2];
  const color = mn < 0 ? '#ef4444' : lastUp ? '#059669' : '#0891b2';
  return `<polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.8" stroke-linejoin="round"/>`;
}

setTimeout(renderLeaderboard, 500);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ DRILLDOWN PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentDrillName = null;
let ddNorm = 'abs'; // 'abs' | 'pct'

function openDrilldown(name) {
  currentDrillName = name;
  ddNorm = 'abs';
  document.getElementById('ddOverlay').classList.remove('modal-hidden');
  document.body.style.overflow = 'hidden';
  renderDrilldown(name);
}

function closeDrilldown() {
  document.getElementById('ddOverlay').classList.add('modal-hidden');
  document.body.style.overflow = '';
  if (ddTrendChart) { ddTrendChart.destroy(); ddTrendChart = null; }
}

function setNorm(btn) {
  ddNorm = btn.dataset.norm;
  document.querySelectorAll('.ntog').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (currentDrillName) renderDrilldownWaterfall(currentDrillName);
}

function renderDrilldown(name) {
  const d = DataAdapter.summary(name); if (!d) return;
  const m = DataAdapter.monthly(name);
  document.getElementById('ddEntityName').textContent = name;
  const typeLabel = d.type === 'branch' ? '×¡× ×™×£' : d.type === 'dept' ? '××—×œ×§×”' : '×™×©×•×ª';
  document.getElementById('ddEntitySub').textContent = `${typeLabel} â€¢ ×œ×—×¥ ×¢×œ ×™×©×•×ª ××—×¨×ª ×‘-Leaderboard ×œ××¢×‘×¨`;

  // â”€â”€ KPI Row â”€â”€
  const n2 = m ? m.rev.length : 0;
  const currRev  = m ? m.rev[n2-1] : d.rev/MONTHS.length;
  const prevRev  = m && n2>=2 ? m.rev[n2-2] : 0;
  const currCont = m ? m.cont[n2-1] : 0;
  const prevCont = m && n2>=2 ? m.cont[n2-2] : 0;
  const currMarg = currRev > 0 ? currCont/currRev*100 : 0;
  const prevMarg = prevRev > 0 ? prevCont/prevRev*100 : 0;
  const netMarg  = DataAdapter.netAvg('cont');
  const totals   = DataAdapter.netTotals();
  const netRevAvg = totals.rev / (DataAdapter.entities().filter(n=>DataAdapter.summary(n)?.rev>0).length||1) / MONTHS.length;

  const kpis = [
    { label:'×”×›× ×¡×•×ª (×—×•×“×© ××—×¨×•×Ÿ)', val:fmt(currRev), delta:prevRev>0?((currRev-prevRev)/prevRev*100).toFixed(1):null, benchmark: fmt(netRevAvg), bLabel:'×××•×¦×¢ ×¨×©×ª' },
    { label:'×ª×¨×•××” ×™×©×™×¨×”', val:fmt(currCont), delta:prevCont!==0?((currCont-prevCont)/Math.abs(prevCont)*100).toFixed(1):null, benchmark: null },
    { label:'××¨×•×•×— %', val:currMarg.toFixed(1)+'%', delta:(currMarg-prevMarg).toFixed(1), benchmark: netMarg.toFixed(1)+'%', bLabel:'×××•×¦×¢ ×¨×©×ª' },
    { label:'×©×›×¨ ×¨×•×¤××™× %', val: currRev>0?(m?m.dr[n2-1]:d.dr)/currRev*100>0?((m?m.dr[n2-1]:d.dr)/currRev*100).toFixed(1)+'%':'â€”':'â€”', delta:null, benchmark: DataAdapter.netAvg('dr').toFixed(1)+'%', bLabel:'×××•×¦×¢ ×¨×©×ª' },
    { label:'×©×™× ×•×™ ××¨×•×•×— (MoM)', val:(currMarg-prevMarg>0?'+':'')+((currMarg-prevMarg).toFixed(1))+'pp', delta:null, benchmark:null },
    { label:'×¡×”×´×› 6 ×—×•×“×©×™×', val:fmt(d.rev), delta:null, benchmark:null },
  ];

  document.getElementById('ddKpiRow').innerHTML = kpis.map(k => {
    const dNum = parseFloat(k.delta);
    const dClass = k.delta == null ? '' : dNum > 0 ? 'up' : dNum < 0 ? 'down' : '';
    const dText  = k.delta == null ? '' : `${dNum>0?'â–²':'â–¼'} ${Math.abs(dNum).toFixed(1)}${k.label.includes('%')?'pp':'%'}`;
    return `<div class="kpi-box">
      <div class="kpi-box-label">${k.label}</div>
      <div class="kpi-box-val">${k.val}</div>
      ${dText ? `<div class="kpi-box-delta ${dClass}">${dText} ×œ×¢×•××ª ×—×•×“×© ×§×•×“×</div>` : ''}
      ${k.benchmark ? `<div style="font-size:0.62rem;color:#94a3b8;margin-top:0.2rem">${k.bLabel||''}:  ${k.benchmark}</div>` : ''}
    </div>`;
  }).join('');

  // â”€â”€ Waterfall â”€â”€
  renderDrilldownWaterfall(name);

  // â”€â”€ Trend Chart â”€â”€
  if (ddTrendChart) { ddTrendChart.destroy(); ddTrendChart = null; }
  if (m) {
    setTimeout(() => {
      const ctx = document.getElementById('ddTrendChart'); if (!ctx) return;
      ddTrendChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: MONTHS,
          datasets: [
            { label:'×”×›× ×¡×•×ª', data:m.rev, borderColor:'#0891b2', borderWidth:2, pointRadius:3.5, tension:0.35, fill:false, yAxisID:'y' },
            { label:'×ª×¨×•××” ×™×©×™×¨×”', data:m.cont, borderColor:'#059669', borderWidth:2, pointRadius:3.5, tension:0.35, fill:false, yAxisID:'y' },
            { label:'××¨×•×•×— %', data:m.rev.map((r,i)=>r>0?parseFloat((m.cont[i]/r*100).toFixed(1)):0),
              borderColor:'#f59e0b', borderWidth:2, pointRadius:3, tension:0.35, fill:false, borderDash:[4,3], yAxisID:'y2' },
          ]
        },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ position:'bottom', rtl:true, labels:{ font:{family:'Heebo',size:10}, padding:8, usePointStyle:true }}},
          scales:{
            y:  { ticks:{color:'#94a3b8',font:{family:'Heebo',size:10},callback:v=>fmt(v)}, grid:{color:'#f0f4fb'} },
            y2: { position:'left', ticks:{color:'#f59e0b',font:{family:'Heebo',size:10},callback:v=>v+'%'}, grid:{display:false} }
          }
        }
      });
    }, 50);
  }
}

function renderDrilldownWaterfall(name) {
  const m = DataAdapter.monthly(name); if (!m) return;
  const n2 = m.rev.length; if (n2 < 2) return;
  const el = document.getElementById('ddWaterfall'); if (!el) return;

  const prev = { rev:m.rev[n2-2], dr:m.dr[n2-2], em:m.em[n2-2], co:m.co[n2-2], vm:m.vm[n2-2], cont:m.cont[n2-2] };
  const curr = { rev:m.rev[n2-1], dr:m.dr[n2-1], em:m.em[n2-1], co:m.co[n2-1], vm:m.vm[n2-1], cont:m.cont[n2-1] };

  const rows = [
    { label:'Î” ×”×›× ×¡×•×ª',       val: curr.rev - prev.rev,   color:'#0891b2', base: prev.rev },
    { label:'Î” ×©×›×¨ ×¨×•×¤××™×',   val:-(curr.dr  - prev.dr),  color:'#7c3aed', base: prev.dr },
    { label:'Î” ×©×›×¨ ×¢×•×‘×“×™×',   val:-(curr.em  - prev.em),  color:'#a855f7', base: prev.em },
    { label:'Î” ×§×‘×œ× ×™×',       val:-(curr.co  - prev.co),  color:'#0284c7', base: prev.co },
    { label:'Î” ×•×˜××¨×§×˜',       val:-(curr.vm  - prev.vm),  color:'#d97706', base: prev.vm },
    { label:'×©×™× ×•×™ ×ª×¨×•××”',    val: curr.cont - prev.cont, color: curr.cont-prev.cont>0?'#059669':'#dc2626', base: prev.cont },
  ];

  const maxAbs = Math.max(...rows.map(r => Math.abs(r.val)), 1);
  el.innerHTML = rows.map(r => {
    let display, pctOfRev;
    if (ddNorm === 'pct') {
      pctOfRev = r.base > 0 ? (r.val / r.base * 100) : 0;
      display = `${r.val >= 0 ? '+' : ''}${pctOfRev.toFixed(1)}%`;
    } else {
      display = (r.val >= 0 ? '+' : '') + fmt(r.val);
    }
    const barPct = (Math.abs(r.val) / maxAbs * 100).toFixed(1);
    const isPos = r.val >= 0;
    return `<div class="wf-row">
      <div class="wf-label">${r.label}</div>
      <div class="wf-track">
        <div class="wf-fill" style="width:${barPct}%;background:${r.color};opacity:${isPos?0.85:0.7}"></div>
      </div>
      <div class="wf-val" style="color:${r.val<0?'#dc2626':'#059669'}">${display}</div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ENHANCED ALERTS â€” threshold + z-score anomaly detection
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let alertFilterSev = 'all';

function setAlertFilter(sev, btn) {
  alertFilterSev = sev;
  document.querySelectorAll('.alerts-section .lb-ftab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderAlerts();
}

function renderAlerts() {
  const el = document.getElementById('alertList'); if (!el) return;
  const ents = DataAdapter.entities().filter(n => DataAdapter.summary(n)?.rev > 0);
  const alerts = [];

  ents.forEach(name => {
    const d = DataAdapter.summary(name);
    const m = DataAdapter.monthly(name);
    const margin = d.rev > 0 ? d.cont/d.rev*100 : 0;
    const drPct  = d.rev > 0 ? d.dr/d.rev*100 : 0;
    const zs = DataAdapter.zScore(name);
    const isSmallBase = d.rev < 300000; // flag small base effect

    // â”€â”€ Threshold alerts â”€â”€
    if (d.cont < 0) {
      alerts.push({ sev:'high', icon:'ğŸš¨', title:`${name} â€” ×ª×¨×•××” ×™×©×™×¨×” ×©×œ×™×œ×™×ª`,
        desc:`×ª×¨×•××”: ${fmt(d.cont)} (${margin.toFixed(1)}% ××¨×•×•×—). ×”×’×“×¨×”: ×™×©×•×ª ×‘×”×¤×¡×“ ×ª×¤×¢×•×œ×™ ×™×©×™×¨.`,
        meta: isSmallBase ? '×‘×¡×™×¡ ×§×˜×Ÿ: ×”×›× ×¡×•×ª × ××•×›×•×ª ×™×—×¡×™×ª â€” ×™×© ×œ×”×ª×™×™×—×¡ ×œ××—×•×–×™× ×‘×–×”×™×¨×•×ª' : '',
        name });
    } else if (margin < 15) {
      alerts.push({ sev: margin < 0 ? 'high' : 'medium', icon:'âš ï¸', title:`${name} â€” ××¨×•×•×— × ××•×š ×-15%`,
        desc:`××¨×•×•×— × ×•×›×—×™: ${margin.toFixed(1)}%. ×¡×£ ×§×¨×™×˜×™: 20%. ×××•×¦×¢ ×¨×©×ª: ${DataAdapter.netAvg('cont').toFixed(1)}%.`,
        meta: isSmallBase ? `âš ï¸ ×‘×¡×™×¡ ×§×˜×Ÿ â€” ×”×›× ×¡×•×ª ${fmt(d.rev)}: ×©×™× ×•×™ ×§×˜×Ÿ ×‘×”×›× ×¡×•×ª ××–×™×– ××ª ×”××—×•×– ××©××¢×•×ª×™×ª` : '',
        name });
    }

    if (drPct > 55) {
      alerts.push({ sev:'medium', icon:'ğŸ’°', title:`${name} â€” ×©×›×¨ ×¨×•×¤××™× ×’×‘×•×” ××”×××•×¦×¢`,
        desc:`×©×›×¨ ×¨×•×¤××™×: ${drPct.toFixed(1)}% ××”×›× ×¡×•×ª. ×××•×¦×¢ ×¨×©×ª: ${DataAdapter.netAvg('dr').toFixed(1)}%. ×¤×¢×¨: +${(drPct - DataAdapter.netAvg('dr')).toFixed(1)}pp.`,
        meta: isSmallBase ? 'âš ï¸ ×‘×¡×™×¡ ×§×˜×Ÿ â€” ×™×™×ª×›×Ÿ ×¢×™×•×•×ª ×¡×˜×˜×™×¡×˜×™' : '',
        name });
    }

    // â”€â”€ MoM drop â”€â”€
    const mom = DataAdapter.mom(name);
    if (mom && mom.delta < -8) {
      alerts.push({ sev:'high', icon:'ğŸ“‰', title:`${name} â€” ×™×¨×™×“×ª ××¨×•×•×— ×—×“×” (${MONTHS[MONTHS.length-2]}â†’${MONTHS[MONTHS.length-1]})`,
        desc:`×™×¨×™×“×”: ${mom.delta.toFixed(1)}pp. ××¨×•×•×—: ${mom.prev.toFixed(1)}%â†’${mom.curr.toFixed(1)}%.`,
        meta: isSmallBase ? 'âš ï¸ ××¤×§×˜ ×‘×¡×™×¡ ×§×˜×Ÿ â€” ×”×›× ×¡×•×ª × ××•×›×•×ª ××’×‘×™×¨×•×ª ×ª× ×•×“×ª×™×•×ª' : '',
        name });
    } else if (mom && mom.delta > 8) {
      alerts.push({ sev:'good', icon:'ğŸš€', title:`${name} â€” ×©×™×¤×•×¨ ××¨×•×•×— ××©××¢×•×ª×™`,
        desc:`×¢×œ×™×™×”: +${mom.delta.toFixed(1)}pp. ××¨×•×•×—: ${mom.prev.toFixed(1)}%â†’${mom.curr.toFixed(1)}%.`,
        meta: isSmallBase ? 'âš ï¸ ××¤×§×˜ ×‘×¡×™×¡ ×§×˜×Ÿ â€” ×™×© ×œ×××ª ×‘× ×ª×•× ×™ ×™×—×™×“×•×ª' : '',
        name });
    }

    // â”€â”€ Z-score anomaly â”€â”€
    if (zs && Math.abs(zs.z) > 1.8) {
      const dir = zs.z > 0 ? '×—×™×•×‘×™×ª' : '×©×œ×™×œ×™×ª';
      const zSev = zs.z > 0 ? 'good' : 'medium';
      alerts.push({ sev: zSev, icon: zs.z > 0 ? 'ğŸ“Š' : 'ğŸ”', title:`${name} â€” ×× ×•××œ×™×” ×¡×˜×˜×™×¡×˜×™×ª (z=${zs.z.toFixed(1)})`,
        desc:`××¨×•×•×— × ×•×›×—×™ ${zs.last.toFixed(1)}% â€” ×¡×˜×™×™×ª ×ª×§×Ÿ ${dir} ××”×××•×¦×¢ ×”×”×™×¡×˜×•×¨×™ (Î¼=${zs.mu.toFixed(1)}%, Ïƒ=${zs.sigma.toFixed(1)}%).`,
        meta: isSmallBase ? 'âš ï¸ ×‘×¡×™×¡ ×§×˜×Ÿ â€” z-score ×¢×œ×•×œ ×œ×©×§×£ × ×¤×— ×§×˜×Ÿ ×•×œ× ×©×™× ×•×™ ×××™×ª×™' : '××‘×•×¡×¡ ×¢×œ 6 ×—×•×“×©×™ ×”×™×¡×˜×•×¨×™×”',
        name });
    }
  });

  // Best performer (always show)
  const best = ents.filter(n=>DataAdapter.summary(n).rev>0).reduce((a,b) =>
    (DataAdapter.summary(b).cont/DataAdapter.summary(b).rev) > (DataAdapter.summary(a).cont/DataAdapter.summary(a).rev) ? b : a, ents[0]);
  if (best) {
    const bd = DataAdapter.summary(best);
    alerts.unshift({ sev:'good', icon:'ğŸ†', title:`${best} â€” ××•×‘×™×œ ×”×¨×©×ª`,
      desc:`××¨×•×•×—: ${(bd.cont/bd.rev*100).toFixed(1)}% â€¢ ×ª×¨×•××”: ${fmt(bd.cont)} â€¢ ×”×›× ×¡×•×ª: ${fmt(bd.rev)}.`, meta:'', name: best });
  }

  const filtered = alertFilterSev === 'all' ? alerts : alerts.filter(a => a.sev === alertFilterSev);

  if (!filtered.length) {
    el.innerHTML = `<div style="text-align:center;padding:2rem;color:#94a3b8">××™×Ÿ ×”×ª×¨××•×ª ×‘×§×˜×’×•×¨×™×” ×–×•</div>`;
    return;
  }

  el.innerHTML = filtered.map(a => `
    <div class="alert-card sev-${a.sev}" onclick="openDrilldown('${a.name.replace(/'/g,"\\'")}'); return false;" role="button" tabindex="0">
      <div class="ac-icon">${a.icon}</div>
      <div class="ac-body">
        <div class="ac-title">${a.title}</div>
        <div class="ac-desc">${a.desc}</div>
        ${a.meta ? `<div class="ac-meta">${a.meta}</div>` : ''}
      </div>
      <button onclick="event.stopPropagation();openDrilldown('${a.name.replace(/'/g,"\\'")}');"
        style="flex-shrink:0;padding:0.35rem 0.8rem;border-radius:8px;border:1.5px solid var(--ac);background:transparent;color:var(--ac);font-family:'Heebo',sans-serif;font-size:0.73rem;font-weight:800;cursor:pointer;white-space:nowrap">
        ×ª×—×§×™×¨ â†
      </button>
    </div>`).join('');
}

setTimeout(renderAlerts, 600);

// â”€â”€ Hook: re-render new sections after file upload â”€â”€
const _origInject = injectParsedData;
window.injectParsedData = function(...args) {
  _origInject(...args);
  setTimeout(() => {
    renderDecisionHeader();
    renderLeaderboard();
    renderAlerts();
  }, 300);
};


</script>
</body>
</html>
